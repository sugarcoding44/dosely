<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BunnyDose">
    <title>BunnyDose - Medication Tracker</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê∞</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê∞</text></svg>">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light mode colors */
            --bg-primary: #f2f2f7;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: #8e8e93;
            --text-tertiary: #2d3748;
            --border-color: #e2e8f0;
            --border-light: #f0f0f0;
            --shadow: rgba(0, 0, 0, 0.04);
            --shadow-md: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.5);
            --bottomsheet-bg: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark mode colors */
                --bg-primary: #000000;
                --bg-secondary: #1c1c1e;
                --bg-card: rgba(28, 28, 30, 0.6);
                --text-primary: #ffffff;
                --text-secondary: #8e8e93;
                --text-tertiary: #f2f2f7;
                --border-color: #38383a;
                --border-light: #38383a;
                --shadow: rgba(255, 255, 255, 0.05);
                --shadow-md: rgba(0, 0, 0, 0.3);
                --input-bg: #1c1c1e;
                --modal-bg: rgba(0, 0, 0, 0.85);
                --bottomsheet-bg: #1c1c1e;
            }

            /* Glassmorphism for dark mode */
            .ios-card {
                background: rgba(28, 28, 30, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .stat-card {
                background: rgba(28, 28, 30, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            /* No glassmorphism for bottomsheets */
            .bottomsheet {
                background: #000000 !important;
            }

            .bottomsheet .field-group {
                background: rgba(28, 28, 30, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .bottomsheet-header {
                background: #000000 !important;
                border-bottom: 1px solid #38383a;
            }

            .bottomsheet-content {
                padding: 20px 0 100px 0;
                background: #000000 !important;
            }

            .bottomsheet::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }

            .bottomsheet::-webkit-scrollbar-track {
                background: #000000;
            }

            .bottomsheet::-webkit-scrollbar-thumb {
                background: #000000;
            }

            .symptom-option {
                background: rgba(28, 28, 30, 0.7) !important;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.1) !important;
                color: var(--text-primary) !important;
            }

            .symptom-option.selected {
                background: rgba(102, 126, 234, 0.8) !important;
                border-color: #667eea !important;
            }

            /* White icons in dark mode */
            .nav-icon,
            [data-lucide] {
                stroke: #ffffff;
            }

            .section-label {
                color: #8e8e93;
            }

            /* No glassmorphism for settings modals */
            .settings-modal {
                background: #1c1c1e !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            .medication-item {
                background: rgba(28, 28, 30, 0.7) !important;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .radio-item {
                background: rgba(28, 28, 30, 0.7) !important;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.1) !important;
            }

            /* Red gradient for email verification text */
            .verify-email-text {
                background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%) !important;
                -webkit-background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                background-clip: text !important;
            }

            /* Subtle red focus border in dark mode */
            input:focus, select:focus, textarea:focus {
                border-color: #991b1b !important;
                box-shadow: 0 0 0 3px rgba(153, 27, 27, 0.15) !important;
            }

            /* Onboarding modal dark mode */
            .modal-content {
                background: #1c1c1e !important;
            }

            .modal-title {
                color: var(--text-primary) !important;
            }

            #onboardingModal h2,
            #onboardingModal h3 {
                color: var(--text-primary) !important;
            }

            #onboardingModal p {
                color: var(--text-secondary) !important;
            }

            #onboardingModal label {
                color: var(--text-primary) !important;
            }

            /* BMI display boxes in onboarding */
            #bmiDisplay {
                background: rgba(28, 28, 30, 0.7) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
            }

            #bmiDisplay * {
                color: var(--text-primary) !important;
            }

            #bmiCategory {
                color: var(--text-secondary) !important;
                border-top-color: rgba(255, 255, 255, 0.1) !important;
            }

            #goalBMIDisplay {
                background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%) !important;
            }

            /* Onboarding summary card */
            #onboardingSummaryCard {
                background: rgba(28, 28, 30, 0.7) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
            }

            #onboardingSummaryCard * {
                color: var(--text-primary) !important;
            }

            #summaryTotalLoss {
                color: #dc2626 !important;
            }

            #onboardingStep5 .onboarding-goal-card {
                background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%) !important;
            }

            /* Onboarding range slider labels - colors are set dynamically by JS */

            /* Unit selector buttons in dark mode */
            #metricBtn, #imperialBtn {
                background: var(--bg-secondary) !important;
                color: var(--text-secondary) !important;
            }

            #metricBtn.active, #imperialBtn.active {
                background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%) !important;
                color: white !important;
            }

            /* Titration schedule in dark mode */
            #titrationScheduleList > div {
                background: rgba(28, 28, 30, 0.7) !important;
                border-left-color: #dc2626 !important;
            }

            #titrationScheduleList > div strong,
            #titrationScheduleList > div span,
            #titrationScheduleList > div small {
                color: var(--text-primary) !important;
            }

            .radio-item:has(input:checked) {
                background: rgba(0, 122, 255, 0.2) !important;
                border-color: #007AFF !important;
            }

            .radio-label {
                color: var(--text-primary);
            }

            .badge-success {
                background: rgba(13, 115, 55, 0.3);
                color: #4ade80;
            }

            .badge-secondary {
                background: rgba(142, 142, 147, 0.3);
                color: #a1a1aa;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        html {
            background: #000000;
            margin: 0;
            padding: 0;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: radial-gradient(ellipse at top, #1a0505 0%, #000000 50%);
                background-attachment: fixed;
            }

            html {
                background: #000000;
            }
        }

        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0;
            background: var(--bg-primary);
            padding-bottom: 100px;
        }

        .logo {
            text-align: center;
            padding: 40px 20px 30px;
        }

        .logo h1 {
            font-size: 42px;
            color: var(--text-tertiary);
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .logo-bunny {
            font-size: 60px;
            display: block;
            margin-bottom: 10px;
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 14px;
            margin-top: 5px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--input-bg);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        input[type="date"],
        input[type="time"] {
            padding: 12px 14px;
            line-height: 1.5;
            display: flex;
            align-items: center;
        }

        input[type="date"]::-webkit-datetime-edit-text,
        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field {
            color: var(--text-primary);
        }

        input[type="date"]::-webkit-datetime-edit {
            padding: 0;
        }

        /* Fix date input height and alignment */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            padding: 4px;
        }

        @media (prefers-color-scheme: dark) {
            input[type="date"]::-webkit-calendar-picker-indicator,
            input[type="time"]::-webkit-calendar-picker-indicator {
                filter: invert(1);
            }
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #dc2626 0%, #34c759 50%, #dc2626 100%);
            border-radius: 10px;
            outline: none;
            padding: 0;
            margin: 15px 0;
            height: 8px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            background: white;
            border: 3px solid #dc2626;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: white;
            border: 3px solid #dc2626;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
        }

        /* Modern Slider for Onboarding */
        .modern-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #dc2626 0%, #34c759 50%, #dc2626 100%);
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            margin: 0;
        }

        .modern-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            background: white;
            border: 3px solid #dc2626;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            transition: all 0.2s;
        }

        .modern-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
        }

        .modern-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: white;
            border: 3px solid #dc2626;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            transition: all 0.2s;
        }

        .modern-slider::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .slider-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .slider-label-center {
            font-weight: 600;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
            }

            ::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.3);
            }
        }

        /* Bottomsheet Styles - iOS Shotsy Design */
        .bottomsheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bottomsheet-bg);
            border-radius: 0;
            box-shadow: 0 -4px 24px var(--shadow-md);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
            padding-top: max(env(safe-area-inset-top), 44px);
        }

        .bottomsheet.show {
            transform: translateY(0);
        }

        .bottomsheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
        }

        .bottomsheet-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .bottomsheet-header {
            padding: 12px 20px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .bottomsheet-cancel {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 17px;
            cursor: pointer;
            padding: 0;
        }

        .bottomsheet-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .bottomsheet-save {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
        }

        .bottomsheet-content {
            padding: 20px 0 100px 0;
            background: #000000;
        }

        .section-label {
            font-size: 13px;
            color: #8e8e93;
            font-weight: 400;
            text-transform: uppercase;
            margin: 20px 0 8px 0;
            letter-spacing: -0.08px;
        }

        .section-label:first-child {
            margin-top: 0;
        }

        .field-group {
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
        }

        .field-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 16px;
            border-bottom: 0.5px solid var(--border-color);
            min-height: 44px;
        }

        .field-row:last-child {
            border-bottom: none;
        }

        .field-label {
            font-size: 17px;
            color: var(--text-primary);
            font-weight: 400;
        }

        .field-value {
            font-size: 17px;
            color: #007AFF;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-value.placeholder {
            color: #8e8e93;
        }

        .field-value input[type="text"],
        .field-value input[type="number"],
        .field-value input[type="date"],
        .field-value select {
            border: none;
            background: none;
            text-align: right;
            font-size: 17px;
            color: var(--text-primary);
            width: auto;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        input[type="date"].field-value,
        input[type="time"].field-value {
            border: none;
            background: none;
            text-align: right;
            font-size: 17px;
            color: #007AFF;
            width: auto;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        input[type="number"].field-value,
        input[type="text"].field-value {
            border: none;
            background: none;
            text-align: right;
            font-size: 17px;
            color: var(--text-primary);
            width: auto;
            min-width: 60px;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        select.field-value {
            border: none;
            background: none;
            text-align: right;
            font-size: 17px;
            color: #007AFF;
            width: auto;
            padding: 0;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .field-value input::placeholder,
        input.field-value::placeholder {
            color: #c6c6c8;
        }

        .field-input {
            border: none;
            background: none;
            text-align: right;
            font-size: 17px;
            color: var(--text-primary);
            width: auto;
            padding: 0;
        }

        .field-input::placeholder {
            color: #c6c6c8;
        }

        .date-picker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 16px;
        }

        .date-arrow {
            font-size: 20px;
            color: #007AFF;
            cursor: pointer;
            user-select: none;
            padding: 0 8px;
        }

        .date-display {
            font-size: 17px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .notes-field {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 11px 16px;
            min-height: 70px;
        }

        .notes-field textarea {
            width: 100%;
            border: none;
            background: none;
            font-size: 17px;
            color: var(--text-primary);
            resize: none;
            font-family: inherit;
            min-height: 60px;
        }

        .notes-field textarea::placeholder {
            color: #c6c6c8;
        }

        textarea.notes-field {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 17px;
            color: var(--text-primary);
            resize: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 60px;
            padding: 0;
        }

        textarea.notes-field::placeholder {
            color: #c6c6c8;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #718096;
        }

        .filter-btn:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, #b91c1c 0%, #6b1515 100%);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }

        .tab-content {
            display: none;
        }

        /* Bottom Navigation Bar - iOS Shotsy Style */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 20px 0;
            z-index: 999;
            box-shadow: 0 -2px 10px var(--shadow);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 4px 0;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 10px;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: #007AFF;
        }

        .nav-item.active .nav-icon {
            stroke: #007AFF;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* Page Container */
        .page {
            display: none;
            min-height: 100vh;
            padding-bottom: 80px;
            background: var(--bg-primary);
        }

        .page.active {
            display: block;
        }

        /* Page Header */
        .page-header {
            background: var(--bg-primary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .header-btn {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 17px;
            cursor: pointer;
            padding: 0;
        }

        .header-icon {
            font-size: 22px;
            color: #007AFF;
        }

        /* Page Content */
        .page-content {
            padding: 16px;
        }

        /* iOS Style Cards */
        .ios-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .ios-card-header {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        /* Calendar Styles */
        .calendar-header {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 20px 0 15px 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--border-light);
        }

        .calendar-day.today {
            background: #007AFF;
            color: white;
            font-weight: 600;
        }

        .calendar-day.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
            transform: scale(1.05);
        }

        .calendar-day.has-data {
            font-weight: 600;
        }

        .calendar-day.has-data.old::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: #007AFF;
            border-radius: 50%;
        }

        .calendar-day.today.has-data::after {
            background: white;
        }

        /* Settings List */
        .settings-list {
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 0.5px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item:active {
            background: var(--border-light);
        }

        .setting-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-icon {
            width: 20px;
            height: 20px;
        }

        .setting-label {
            font-size: 17px;
            color: var(--text-primary);
        }

        .setting-chevron {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .tab-content.active {
            display: block;
        }

        .entry {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .entry-date {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 15px;
        }

        .entry-badge {
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .entry-badge.dose {
            background: #ddd6fe;
            color: #7c3aed;
        }

        .entry-badge.weight {
            background: #dbeafe;
            color: #2563eb;
        }

        .entry-badge.side-effect {
            background: #fed7aa;
            color: #ea580c;
        }

        .entry-details {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .calculator-result {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid #48bb78;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.15);
        }

        .calculator-result-label {
            font-size: 11px;
            color: #718096;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .calculator-result-value {
            font-size: 36px;
            font-weight: 700;
            color: #48bb78;
        }

        .next-dose-card {
            background: var(--bg-card);
            color: var(--text-tertiary);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow);
            border: 2px solid #667eea;
        }

        .next-dose-label {
            font-size: 11px;
            color: #718096;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .next-dose-date {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #667eea;
        }

        .next-dose-amount {
            font-size: 16px;
            color: #4a5568;
        }

        .medication-card {
            background: var(--bg-card);
            color: var(--text-tertiary);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid #667eea;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .medication-card:active {
            transform: scale(0.98);
        }

        .medication-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #667eea;
        }

        .medication-info {
            font-size: 14px;
            color: #718096;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .header-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .header-welcome {
            font-size: 24px;
            font-weight: 700;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-logout, .btn-export {
            background: var(--bg-card);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-logout:hover, .btn-export:hover {
            background: #f8f9fa;
            border-color: #cbd5e0;
        }

        .btn-export {
            color: #667eea;
            border-color: #667eea;
        }

        .btn-export:hover {
            background: #f7fafc;
        }

        .hidden {
            display: none !important;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .severity-mild { color: #10b981; }
        .severity-moderate { color: #f59e0b; }
        .severity-severe { color: #ef4444; }

        .info-box {
            background: #fef3c7;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #92400e;
            line-height: 1.6;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 99999;
            opacity: 0;
            transition: all 0.3s ease;
            border-left: 4px solid #48bb78;
            max-width: 90%;
            min-width: 250px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-icon {
            font-size: 24px;
        }

        .toast-message {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 15px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .quick-action-btn:active {
            transform: scale(0.95);
        }

        .quick-action-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }

        .quick-action-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Weight Goal */
        .goal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .goal-content {
            position: relative;
            z-index: 2;
        }

        .goal-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .goal-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .goal-current {
            font-size: 32px;
            font-weight: 700;
        }

        .goal-target {
            font-size: 18px;
            opacity: 0.9;
        }

        .goal-progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .goal-progress-fill {
            background: white;
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .goal-remaining {
            font-size: 14px;
            opacity: 0.9;
        }

        .goal-edit-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
        }

        /* Symptom Selector */
        .symptom-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .symptom-option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }

        .symptom-option.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .symptom-option:active {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .onboarding-step {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .onboarding-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding-top: 20px;
            margin-top: auto;
        }

        @media (prefers-color-scheme: dark) {
            .onboarding-buttons {
                background: #1c1c1e;
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .settings-modal {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-item {
            background: var(--bg-primary);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .radio-item:has(input:checked) {
            background: rgba(0, 122, 255, 0.1);
            border-color: #007AFF;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #007AFF;
        }

        .radio-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .radio-description {
            font-size: 13px;
            color: #8e8e93;
        }

        .medication-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .medication-item {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1f4e0;
            color: #0d7337;
        }

        .badge-secondary {
            background: #e5e5ea;
            color: #8e8e93;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="logo">
            <span class="logo-bunny">üê∞</span>
            <h1>BunnyDose</h1>
            <p>Bunny's GLP-1 Tracker</p>
        </div>

        <div class="card">
            <div class="card-title" id="authTitle">Welcome Back</div>

            <div class="form-group" id="emailGroup">
                <label id="emailLabel">Email or Username</label>
                <input type="text" id="authEmail" placeholder="your@email.com or username">
            </div>

            <div class="form-group" id="usernameGroup" style="display: none;">
                <label>Username</label>
                <input type="text" id="authUsername" placeholder="Choose a username">
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div id="forgotPasswordLink" style="text-align: right; margin-bottom: 12px;">
                <a href="#" onclick="showForgotPassword(); return false;" style="color: #8b8b8b; font-size: 14px; text-decoration: none; font-weight: 500;">Forgot password?</a>
            </div>

            <button class="btn btn-primary" onclick="handleAuth()" id="authButton">Sign In</button>

            <div style="text-align: center; margin-top: 16px;">
                <a href="#" onclick="toggleAuthMode(); return false;" id="toggleAuthLink" style="color: #a1a1a1; font-size: 15px; text-decoration: none; font-weight: 500;">Create an account instead</a>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; padding-bottom: 20px;">
            <p style="color: var(--text-secondary); font-size: 13px; font-weight: 500;">Developed by Kitty HQ</p>
        </div>
    </div>

    <!-- Email Verification Screen -->
    <div id="verifyScreen" class="auth-container hidden">
        <div class="logo">
            <span class="logo-bunny">üìß</span>
            <h1>Check Your Email</h1>
            <p>We sent you a verification link</p>
        </div>

        <div class="card">
            <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 64px; margin-bottom: 20px;">‚úâÔ∏è</div>
                <h3 style="color: #2d3748; margin-bottom: 15px; font-size: 20px;">Verify Your Email</h3>
                <p style="color: #718096; line-height: 1.8; margin-bottom: 20px;">
                    We've sent a verification link to<br>
                    <strong id="verifyEmail" class="verify-email-text" style="color: #667eea;">your@email.com</strong>
                </p>
                <p style="color: #718096; font-size: 14px; line-height: 1.6;">
                    Click the link in the email to verify your account, then come back here to sign in.
                </p>
            </div>
            <button class="btn btn-primary" onclick="backToSignIn()">Back to Sign In</button>
        </div>
    </div>

    <!-- Forgot Password Screen -->
    <div id="forgotPasswordScreen" class="auth-container hidden">
        <div class="logo">
            <span class="logo-bunny">üîë</span>
            <h1>Reset Password</h1>
            <p>We'll send you a reset link</p>
        </div>

        <div class="card">
            <div class="card-title">Enter Your Email</div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="resetEmail" placeholder="your@email.com">
            </div>

            <button class="btn btn-primary" onclick="handleForgotPassword()">Send Reset Link</button>
            <button class="btn btn-secondary" onclick="backToSignIn()">Back to Sign In</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span class="toast-icon" id="toastIcon">‚úì</span>
        <span class="toast-message" id="toastMessage">Success!</span>
    </div>

    <!-- Modal Container for Settings -->
    <div id="modalContainer" class="hidden"></div>

    <!-- Weight Goal Modal -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Set Weight Goal</div>

            <div class="form-group">
                <label>Target Weight (kg)</label>
                <input type="number" id="goalWeight" step="0.1" placeholder="75.0">
            </div>

            <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
            <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <!-- Step 1: Welcome -->
            <div id="onboardingStep1" class="onboarding-step">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 64px; margin-bottom: 15px;">üê∞</div>
                    <h2 style="font-size: 28px; color: #2d3748; margin-bottom: 10px;">Welcome to BunnyDose!</h2>
                    <p style="color: #718096; font-size: 16px; line-height: 1.6;">Let's set up your weight loss journey. This will only take a minute.</p>
                </div>
                <button class="btn btn-primary" onclick="nextOnboardingStep(2)">Get Started</button>
            </div>

            <!-- Step 2: Medication Info -->
            <div id="onboardingStep2" class="onboarding-step hidden">
                <div class="modal-title">Medication Details</div>

                <div class="form-group">
                    <label>What medication are you taking?</label>
                    <select id="onboardingMedicationType">
                        <option value="">Select medication</option>
                        <option value="Semaglutide">Semaglutide (Ozempic/Wegovy)</option>
                        <option value="Tirzepatide">Tirzepatide (Mounjaro/Zepbound)</option>
                        <option value="Retatrutide">Retatrutide</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>When did you start your shots?</label>
                    <input type="date" id="onboardingStartDate" placeholder="Select date">
                </div>

                <div class="form-group">
                    <label>Starting Dose (mg)</label>
                    <input type="number" id="onboardingStartDose" value="1" step="0.1" placeholder="1.0">
                </div>

                <div class="form-group">
                    <label>Vial Concentration (mg)</label>
                    <input type="number" id="onboardingVialMg" value="10" placeholder="10">
                </div>

                <div class="form-group">
                    <label>Reconstitution Volume (ml)</label>
                    <input type="number" id="onboardingVialMl" value="3" step="0.1" placeholder="3.0">
                </div>

                <button class="btn btn-primary" onclick="nextOnboardingStep(3)">Next</button>
                <button class="btn btn-secondary" onclick="prevOnboardingStep(1)">Back</button>
            </div>

            <!-- Step 3: Weight Info -->
            <div id="onboardingStep3" class="onboarding-step hidden">
                <div class="modal-title">Weight & Body Information</div>

                <!-- Unit Selector -->
                <div style="margin-bottom: 20px;">
                    <div style="display: inline-flex; background: var(--bg-secondary); border-radius: 10px; padding: 4px;">
                        <button onclick="switchOnboardingUnit('metric')" id="metricBtn" class="active" style="padding: 8px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            kg / cm
                        </button>
                        <button onclick="switchOnboardingUnit('imperial')" id="imperialBtn" style="padding: 8px 20px; border: none; border-radius: 8px; background: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            lbs / in
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label id="heightLabel">Height (cm)</label>
                    <input type="number" id="onboardingHeight" step="0.1" placeholder="170" oninput="calculateOnboardingBMI()">
                </div>

                <div class="form-group">
                    <label id="startWeightLabel">Weight on Start Date (kg)</label>
                    <input type="number" id="onboardingStartWeight" step="0.1" placeholder="86.7" oninput="calculateOnboardingBMI()">
                </div>

                <div class="form-group">
                    <label id="currentWeightLabel">Current Weight (kg)</label>
                    <input type="number" id="onboardingCurrentWeight" step="0.1" placeholder="85.6" oninput="calculateOnboardingBMI()">
                </div>

                <div id="bmiDisplay" style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 13px; color: #718096; margin-bottom: 4px;">Starting BMI</div>
                            <div style="font-size: 24px; font-weight: 700; color: #2d3748;"><span id="startBMI">--</span></div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #718096; margin-bottom: 4px;">Current BMI</div>
                            <div style="font-size: 24px; font-weight: 700; color: #667eea;"><span id="currentBMI">--</span></div>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #8e8e93; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;" id="bmiCategory">--</div>
                </div>

                <div class="form-group">
                    <label id="goalWeightLabel">Goal Weight (kg)</label>
                    <input type="number" id="onboardingGoalWeight" step="0.1" placeholder="75.0" oninput="calculateOnboardingBMI()">
                </div>

                <div id="goalBMIDisplay" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">Goal BMI</div>
                    <div style="font-size: 28px; font-weight: 700;"><span id="goalBMI">--</span></div>
                </div>

                <div class="form-group">
                    <label>Weekly Weight Loss Target: <strong><span id="weeklyLossValue">0.5</span> <span id="weeklyLossUnit">kg</span>/week</strong></label>
                    <div style="position: relative; margin: 20px 0;">
                        <input type="range" id="onboardingWeeklyLoss" min="0.3" max="1.0" step="0.1" value="0.5" oninput="updateWeeklyLossDisplay(this.value)" class="modern-slider">
                        <div class="slider-labels">
                            <span class="slider-label" id="slowLabel">Slow</span>
                            <span class="slider-label slider-label-center" id="healthyLabel">Healthy</span>
                            <span class="slider-label" id="fastLabel">Fast</span>
                        </div>
                    </div>
                    <small style="color: #718096; font-size: 13px; display: block; margin-top: 8px;">üí° <span id="idealRangeText">0.5-0.7 kg per week is ideal for sustainable weight loss</span></small>
                </div>

                <div class="onboarding-buttons">
                    <button class="btn btn-primary" onclick="nextOnboardingStep(4)">Next</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep(2)">Back</button>
                </div>
            </div>

            <!-- Step 4: Titration Plan -->
            <div id="onboardingStep4" class="onboarding-step hidden">
                <div class="modal-title">Dose Titration Plan</div>

                <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">Set up your dosing schedule. You can adjust this later.</p>

                <div class="form-group">
                    <label>Dosing Frequency</label>
                    <select id="onboardingFrequency">
                        <option value="3.5">Twice weekly (every 3-4 days)</option>
                        <option value="7">Once weekly</option>
                        <option value="5">Every 5 days</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Titration Schedule</label>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-top: 10px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Week 1-2:</strong> 1mg
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Week 3-5:</strong> 2mg (split: 1mg every 3-4 days)
                        </div>
                        <div>
                            <strong>Week 6+:</strong> Increase as tolerated
                        </div>
                    </div>
                    <small style="color: #718096; font-size: 13px; margin-top: 10px; display: block;">You can customize this in settings later</small>
                </div>

                <button class="btn btn-primary" onclick="completeOnboarding()">Complete Setup</button>
                <button class="btn btn-secondary" onclick="prevOnboardingStep(3)">Back</button>
            </div>

            <!-- Step 5: Summary -->
            <div id="onboardingStep5" class="onboarding-step hidden">
                <div style="text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px;">üéâ</div>
                    <h2 style="font-size: 28px; color: #2d3748; margin-bottom: 15px;">All Set!</h2>

                    <div class="onboarding-goal-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 16px; margin: 20px 0;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">ESTIMATED GOAL DATE</div>
                        <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;" id="onboardingGoalDate">--</div>
                        <div style="font-size: 16px; opacity: 0.9;" id="onboardingWeeksToGoal">--</div>
                    </div>

                    <div id="onboardingSummaryCard" style="background: #f7fafc; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left;">
                        <div style="font-size: 14px; color: #718096; margin-bottom: 15px; font-weight: 600;">YOUR PLAN</div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;">
                            <span style="color: #718096;">Starting Weight:</span>
                            <strong id="summaryStartWeight" style="color: #2d3748;">--</strong>
                        </div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;">
                            <span style="color: #718096;">Goal Weight:</span>
                            <strong id="summaryGoalWeight" style="color: #2d3748;">--</strong>
                        </div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;">
                            <span style="color: #718096;">Total to Lose:</span>
                            <strong id="summaryTotalLoss" style="color: #667eea;">--</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #718096;">Weekly Goal:</span>
                            <strong id="summaryWeeklyLoss" style="color: #2d3748;">--</strong>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="finishOnboarding()">Start Tracking!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Titration Schedule Modal -->
    <div id="titrationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-title">Edit Dose Schedule</div>

            <div id="titrationScheduleList" style="max-height: 400px; overflow-y: auto;"></div>

            <button class="btn btn-primary" onclick="addTitrationWeek()">Add Week</button>
            <button class="btn btn-secondary" onclick="closeTitrationModal()">Close</button>
        </div>
    </div>

    <!-- Bottomsheet Overlay -->
    <div id="bottomsheetOverlay" class="bottomsheet-overlay" onclick="closeAllBottomsheets()"></div>

    <!-- Log Weight Bottomsheet -->
    <div id="weightBottomsheet" class="bottomsheet">
        <div class="bottomsheet-header">
            <button class="bottomsheet-cancel" onclick="closeBottomsheet('weightBottomsheet')">Cancel</button>
            <div class="bottomsheet-title">Add Weight</div>
            <button class="bottomsheet-save" onclick="saveQuickWeight()">Save</button>
        </div>
        <div class="bottomsheet-content">
            <!-- DATE Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">DATE</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row">
                    <span class="field-label">Date</span>
                    <input type="date" id="quickWeightDate" class="field-value date-picker">
                </div>
                <div class="field-row" style="border-bottom: none;">
                    <span class="field-label">Time</span>
                    <input type="time" id="quickWeightTime" class="field-value date-picker">
                </div>
            </div>

            <!-- DETAILS Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">DETAILS</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row" style="border-bottom: none;">
                    <span class="field-label">Weight (kg)</span>
                    <input type="number" id="quickWeightAmount" step="0.1" placeholder="85.6" class="field-value">
                </div>
            </div>

            <!-- NOTES Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">NOTES</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row" style="border-bottom: none;">
                    <textarea id="quickWeightNotes" rows="3" placeholder="Add notes" class="notes-field"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Dose Bottomsheet -->
    <div id="doseBottomsheet" class="bottomsheet">
        <div class="bottomsheet-header">
            <button class="bottomsheet-cancel" onclick="closeBottomsheet('doseBottomsheet')">Cancel</button>
            <div class="bottomsheet-title">Add Shot</div>
            <button class="bottomsheet-save" onclick="saveQuickDose()">Save</button>
        </div>
        <div class="bottomsheet-content">
            <!-- DATE Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">DATE</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row">
                    <span class="field-label">Date</span>
                    <input type="date" id="quickDoseDate" class="field-value date-picker">
                </div>
                <div class="field-row" style="border-bottom: none;">
                    <span class="field-label">Time</span>
                    <input type="time" id="quickDoseTime" class="field-value date-picker">
                </div>
            </div>

            <!-- DETAILS Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">DETAILS</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row">
                    <span class="field-label">Medication</span>
                    <select id="quickDoseMedication" class="field-value">
                        <option value="">Select</option>
                    </select>
                </div>
                <div class="field-row">
                    <span class="field-label">Dose (mg)</span>
                    <input type="number" id="quickDoseAmount" step="0.1" placeholder="1.0" class="field-value">
                </div>
                <div class="field-row">
                    <span class="field-label">Injection Units</span>
                    <input type="number" id="quickDoseUnits" placeholder="30" class="field-value">
                </div>
                <div class="field-row" style="border-bottom: none;">
                    <span class="field-label">Injection Site</span>
                    <select id="quickDoseSite" class="field-value">
                        <option value="">Select</option>
                        <option value="abdomen">Abdomen</option>
                        <option value="thigh">Thigh</option>
                        <option value="arm">Arm</option>
                    </select>
                </div>
            </div>

            <!-- SHOT NOTES Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">SHOT NOTES</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row" style="border-bottom: none;">
                    <textarea id="quickDoseNotes" rows="3" placeholder="Add notes" class="notes-field"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Side Effect Bottomsheet -->
    <div id="sideEffectBottomsheet" class="bottomsheet">
        <div class="bottomsheet-header">
            <button class="bottomsheet-cancel" onclick="closeBottomsheet('sideEffectBottomsheet')">Cancel</button>
            <div class="bottomsheet-title">Add Side Effect</div>
            <button class="bottomsheet-save" onclick="saveQuickSideEffect()">Save</button>
        </div>
        <div class="bottomsheet-content">
            <!-- DATE Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">DATE</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row" style="border-bottom: none;">
                    <span class="field-label">Date</span>
                    <input type="date" id="quickSideEffectDate" class="field-value date-picker">
                </div>
            </div>

            <!-- SYMPTOM Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">SYMPTOM</div>
            <div style="margin: 0 20px 20px 20px;">
                <div class="symptom-grid">
                    <div class="symptom-option" data-symptom="Nausea" onclick="selectQuickSymptom(this)">
                        <div>ü§¢ Nausea</div>
                    </div>
                    <div class="symptom-option" data-symptom="Vomiting" onclick="selectQuickSymptom(this)">
                        <div>ü§Æ Vomiting</div>
                    </div>
                    <div class="symptom-option" data-symptom="Diarrhea" onclick="selectQuickSymptom(this)">
                        <div>üí© Diarrhea</div>
                    </div>
                    <div class="symptom-option" data-symptom="Constipation" onclick="selectQuickSymptom(this)">
                        <div>üö´ Constipation</div>
                    </div>
                    <div class="symptom-option" data-symptom="Heartburn" onclick="selectQuickSymptom(this)">
                        <div>üî• Heartburn</div>
                    </div>
                    <div class="symptom-option" data-symptom="Fatigue" onclick="selectQuickSymptom(this)">
                        <div>üò¥ Fatigue</div>
                    </div>
                    <div class="symptom-option" data-symptom="Headache" onclick="selectQuickSymptom(this)">
                        <div>ü§ï Headache</div>
                    </div>
                    <div class="symptom-option" data-symptom="Dizziness" onclick="selectQuickSymptom(this)">
                        <div>üòµ Dizziness</div>
                    </div>
                    <div class="symptom-option" data-symptom="Injection site reaction" onclick="selectQuickSymptom(this)">
                        <div>üíâ Injection Reaction</div>
                    </div>
                    <div class="symptom-option" data-symptom="Loss of appetite" onclick="selectQuickSymptom(this)">
                        <div>üçΩÔ∏è No Appetite</div>
                    </div>
                    <div class="symptom-option" data-symptom="Burping" onclick="selectQuickSymptom(this)">
                        <div>üí® Burping</div>
                    </div>
                    <div class="symptom-option" data-symptom="Anxious" onclick="selectQuickSymptom(this)">
                        <div>üò∞ Anxious</div>
                    </div>
                    <div class="symptom-option" data-symptom="Other" onclick="selectQuickSymptom(this)">
                        <div>üìù Other</div>
                    </div>
                </div>
                <input type="text" id="quickSymptomOther" class="hidden" placeholder="Describe symptom..." style="margin-top: 10px; width: 100%; padding: 11px 16px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 17px; background: var(--input-bg); color: var(--text-primary);">
            </div>

            <!-- DETAILS Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">DETAILS</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row" style="border-bottom: none;">
                    <span class="field-label">Severity</span>
                    <select id="quickSideEffectSeverity" class="field-value">
                        <option value="mild">Mild</option>
                        <option value="moderate">Moderate</option>
                        <option value="severe">Severe</option>
                    </select>
                </div>
            </div>

            <!-- NOTES Section -->
            <div class="section-label" style="padding: 0 20px; margin-bottom: 8px;">NOTES</div>
            <div class="field-group" style="margin: 0 20px 20px 20px;">
                <div class="field-row" style="border-bottom: none;">
                    <textarea id="quickSideEffectNotes" rows="3" placeholder="Add notes" class="notes-field"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="app-container hidden">
        <!-- OLD UI ELEMENTS - Hidden -->
        <div class="header-user" style="display: none;">
            <div class="header-welcome">Hi, Kai! üê∞</div>
            <div class="header-buttons">
                <button class="btn-export" onclick="exportToExcel()">üìä Export</button>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" style="display: none;">
            <div class="quick-action-btn" onclick="quickLogWeight()">
                <span class="quick-action-icon">‚öñÔ∏è</span>
                <div class="quick-action-label">Log Weight</div>
            </div>
            <div class="quick-action-btn" onclick="quickLogDose()">
                <span class="quick-action-icon">üíâ</span>
                <div class="quick-action-label">Log Dose</div>
            </div>
            <div class="quick-action-btn" onclick="quickLogSideEffect()">
                <span class="quick-action-icon">‚ö†Ô∏è</span>
                <div class="quick-action-label">Side Effect</div>
            </div>
        </div>

        <!-- Weight Goal -->
        <div id="goalCard" class="goal-card hidden" style="display: none;">
            <div class="goal-content">
                <div class="goal-label">Weight Goal</div>
                <div class="goal-progress">
                    <div class="goal-current" id="goalCurrent">--</div>
                    <div class="goal-target">‚Üí <span id="goalTarget">--</span> kg</div>
                </div>
                <div class="goal-progress-bar">
                    <div class="goal-progress-fill" id="goalProgressFill" style="width: 0%"></div>
                </div>
                <div class="goal-remaining" id="goalRemaining">--</div>
                <button class="goal-edit-btn" onclick="openGoalModal()">Edit Goal</button>
            </div>
        </div>

        <!-- Next Dose Reminder Card - HIDDEN OLD UI -->
        <div class="card" id="nextDoseReminderCard" style="display: none !important;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üíâ Next Scheduled Shot</div>
                    <div style="font-size: 28px; font-weight: 700;" id="nextDoseReminderAmount">--</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: 600;" id="nextDoseReminderDate">--</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;" id="nextDoseReminderDays">--</div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Current Weight</div>
                <div class="stat-value" id="currentWeight">--</div>
                <div class="stat-change" id="weightChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Doses</div>
                <div class="stat-value" id="totalDoses">0</div>
                <div class="stat-change" id="lastDose"></div>
            </div>
        </div>

        <!-- Next Dose - HIDDEN OLD UI -->
        <div id="nextDoseCard" class="next-dose-card hidden" style="display: none !important;">
            <div class="next-dose-label">Next Scheduled Dose</div>
            <div class="next-dose-date" id="nextDoseDate">--</div>
            <div class="next-dose-amount" id="nextDoseAmount">--</div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">Current Week: <strong id="currentWeek">--</strong></div>
                <button class="goal-edit-btn" onclick="openTitrationModal()" style="width: 100%; margin-top: 5px;">View Schedule</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" style="display: none;">
            <button class="tab active" onclick="switchTab('dashboard')">Home</button>
            <button class="tab" onclick="switchTab('reta')">Shots</button>
            <button class="tab" onclick="switchTab('log')">Log</button>
            <button class="tab" onclick="switchTab('calculator')">Calc</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('meds')">Meds</button>
        </div>

        <!-- Summary Page -->
        <div id="summaryPage" class="page active">
            <div class="page-header">
                <span></span>
                <div class="page-title">Summary</div>
                <button class="header-btn" onclick="quickLogDose()">+ Add shot</button>
            </div>
            <div class="page-content" id="summaryContent"></div>
        </div>

        <!-- Shots Page -->
        <div id="shotsPage" class="page">
            <div class="page-header">
                <span></span>
                <div class="page-title">Shots</div>
                <button class="header-btn" onclick="quickLogDose()">+ Add shot</button>
            </div>
            <div class="page-content" id="shotsContent"></div>
        </div>

        <!-- Results Page -->
        <div id="resultsPage" class="page">
            <div class="page-header">
                <span></span>
                <div class="page-title">Results</div>
                <button class="header-btn" onclick="quickLogDose()">+ Add shot</button>
            </div>
            <div class="page-content" id="resultsContent"></div>
        </div>

        <!-- Calendar Page -->
        <div id="calendarPage" class="page">
            <div class="page-header">
                <span></span>
                <div class="page-title">Calendar</div>
                <button class="header-btn" onclick="goToToday()">Today</button>
            </div>
            <div class="page-content" id="calendarContent"></div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header">
                <span></span>
                <div class="page-title">Settings</div>
                <span></span>
            </div>
            <div class="page-content" id="settingsContent"></div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchPage('summary')">
                <i data-lucide="file-text" class="nav-icon"></i>
                <div class="nav-label">Summary</div>
            </button>
            <button class="nav-item" onclick="switchPage('shots')">
                <i data-lucide="syringe" class="nav-icon"></i>
                <div class="nav-label">Shots</div>
            </button>
            <button class="nav-item" onclick="switchPage('results')">
                <i data-lucide="trending-up" class="nav-icon"></i>
                <div class="nav-label">Results</div>
            </button>
            <button class="nav-item" onclick="switchPage('calendar')">
                <i data-lucide="calendar" class="nav-icon"></i>
                <div class="nav-label">Calendar</div>
            </button>
            <button class="nav-item" onclick="switchPage('settings')">
                <i data-lucide="settings" class="nav-icon"></i>
                <div class="nav-label">Settings</div>
            </button>
        </div>

        <!-- Dashboard Tab - HIDDEN OLD UI -->
        <div id="dashboardTab" class="tab-content active" style="display: none;">
            <div class="card">
                <div class="card-title">Weight Progress</div>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Dose Tracking</div>
                <div class="chart-container">
                    <canvas id="doseChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Side Effects</div>
                <div id="sideEffectsSummary"></div>
                <div class="chart-container" id="sideEffectsChartContainer" style="display: none;">
                    <canvas id="sideEffectsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Recent Activity</div>
                <div id="recentActivity"></div>
            </div>
        </div>

        <!-- Reta Tracking Tab - HIDDEN OLD UI -->
        <div id="retaTab" class="tab-content" style="display: none;">
            <!-- Dose Schedule Card -->
            <div class="card">
                <div class="card-title">üìÖ Dose Schedule</div>
                <div id="retaDoseSchedule" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                <button class="btn btn-secondary" onclick="openTitrationModal()">Edit Schedule</button>
            </div>

            <!-- Recent Doses -->
            <div class="card">
                <div class="card-title">üíâ Recent Doses</div>
                <div id="retaRecentDoses"></div>
            </div>

            <!-- Dose Chart -->
            <div class="card">
                <div class="card-title">Dose Tracking</div>
                <div class="chart-container">
                    <canvas id="retaDoseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Log Entry Tab -->
        <div id="logTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Log Entry</div>

                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="entryType" onchange="toggleEntryFields()">
                        <option value="dose">Dose</option>
                        <option value="weight">Weight</option>
                        <option value="side-effect">Side Effect</option>
                    </select>
                </div>

                <div class="form-group" id="medicationSelect">
                    <label>Medication</label>
                    <select id="selectedMedication">
                        <option value="">Select medication</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="entryDate">
                </div>

                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="entryTime">
                </div>

                <!-- Dose Fields -->
                <div id="doseFields">
                    <div class="form-group">
                        <label>Dose (mg)</label>
                        <input type="number" id="doseAmount" step="0.1" placeholder="1.0">
                    </div>

                    <div class="form-group">
                        <label>Injection Units</label>
                        <input type="number" id="injectionUnits" placeholder="30">
                    </div>

                    <div class="form-group">
                        <label>Injection Site</label>
                        <select id="injectionSite">
                            <option value="">Select site</option>
                            <option value="abdomen">Abdomen</option>
                            <option value="thigh">Thigh</option>
                            <option value="arm">Arm</option>
                        </select>
                    </div>
                </div>

                <!-- Weight Fields -->
                <div id="weightFields" class="hidden">
                    <div class="form-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="weightAmount" step="0.1" placeholder="85.6">
                    </div>
                </div>

                <!-- Side Effect Fields -->
                <div id="sideEffectFields" class="hidden">
                    <div class="form-group">
                        <label>Select Symptom</label>
                        <div class="symptom-grid">
                            <div class="symptom-option" data-symptom="Nausea" onclick="selectSymptom(this)">
                                <div>ü§¢ Nausea</div>
                            </div>
                            <div class="symptom-option" data-symptom="Fatigue" onclick="selectSymptom(this)">
                                <div>üò¥ Fatigue</div>
                            </div>
                            <div class="symptom-option" data-symptom="Headache" onclick="selectSymptom(this)">
                                <div>ü§ï Headache</div>
                            </div>
                            <div class="symptom-option" data-symptom="Diarrhea" onclick="selectSymptom(this)">
                                <div>üí© Diarrhea</div>
                            </div>
                            <div class="symptom-option" data-symptom="Constipation" onclick="selectSymptom(this)">
                                <div>üöΩ Constipation</div>
                            </div>
                            <div class="symptom-option" data-symptom="Dizziness" onclick="selectSymptom(this)">
                                <div>üí´ Dizziness</div>
                            </div>
                            <div class="symptom-option" data-symptom="Vomiting" onclick="selectSymptom(this)">
                                <div>ü§Æ Vomiting</div>
                            </div>
                            <div class="symptom-option" data-symptom="Loss of Appetite" onclick="selectSymptom(this)">
                                <div>üçΩÔ∏è Loss of Appetite</div>
                            </div>
                            <div class="symptom-option" data-symptom="Heartburn" onclick="selectSymptom(this)">
                                <div>üî• Heartburn</div>
                            </div>
                            <div class="symptom-option" data-symptom="Bloating" onclick="selectSymptom(this)">
                                <div>üéà Bloating</div>
                            </div>
                            <div class="symptom-option" data-symptom="Stomach Pain" onclick="selectSymptom(this)">
                                <div>üò£ Stomach Pain</div>
                            </div>
                            <div class="symptom-option" data-symptom="Other" onclick="selectSymptom(this)">
                                <div>‚úèÔ∏è Other</div>
                            </div>
                        </div>
                        <input type="text" id="symptomOther" class="hidden" placeholder="Describe symptom...">
                    </div>

                    <div class="form-group">
                        <label>Severity</label>
                        <select id="severity">
                            <option value="mild">Mild</option>
                            <option value="moderate">Moderate</option>
                            <option value="severe">Severe</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="entryNotes" rows="3" placeholder="Any observations..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
            </div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculatorTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Dose Calculator</div>

                <div class="info-box">
                    Calculate how many units to inject based on your vial concentration.
                </div>

                <div class="form-group">
                    <label>Vial Concentration (mg)</label>
                    <input type="number" id="calcVialMg" placeholder="10" value="10">
                </div>

                <div class="form-group">
                    <label>Reconstitution Volume (ml)</label>
                    <input type="number" id="calcVialMl" placeholder="3" value="3" step="0.1">
                </div>

                <div class="form-group">
                    <label>Desired Dose (mg)</label>
                    <input type="number" id="calcDesiredDose" placeholder="1" step="0.1">
                </div>

                <button class="btn btn-primary" onclick="calculateDose()">Calculate</button>

                <div id="calculatorResult" class="hidden">
                    <div class="calculator-result">
                        <div class="calculator-result-label">Inject</div>
                        <div class="calculator-result-value" id="calculatedUnits">--</div>
                        <div class="calculator-result-label">units</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Entry History</div>

                <!-- History Filters -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="filter-btn active" onclick="filterHistory('all')">All</button>
                    <button class="filter-btn" onclick="filterHistory('dose')">üíâ Doses</button>
                    <button class="filter-btn" onclick="filterHistory('weight')">‚öñÔ∏è Weight</button>
                    <button class="filter-btn" onclick="filterHistory('side-effect')">‚ö†Ô∏è Side Effects</button>
                </div>

                <div id="historyList"></div>
            </div>
        </div>

        <!-- Medications Tab -->
        <div id="medsTab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">My Medications</div>
                <div id="medicationsList"></div>
                <button class="btn btn-primary" onclick="showAddMedication()">Add Medication</button>
            </div>

            <!-- Add Medication Form -->
            <div id="addMedicationForm" class="card hidden">
                <div class="card-title">Add New Medication</div>

                <div class="form-group">
                    <label>Medication Name</label>
                    <select id="newMedName">
                        <option value="Retatrutide">Retatrutide</option>
                        <option value="Semaglutide">Semaglutide (Ozempic/Wegovy)</option>
                        <option value="Tirzepatide">Tirzepatide (Mounjaro/Zepbound)</option>
                        <option value="Liraglutide">Liraglutide (Saxenda)</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Medication Type</label>
                    <select id="newMedType">
                        <option value="GLP-1/GIP/Glucagon">GLP-1/GIP/Glucagon (Reta)</option>
                        <option value="GLP-1">GLP-1 (Sema, Lira)</option>
                        <option value="GLP-1/GIP">GLP-1/GIP (Tirz)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Vial Concentration (mg)</label>
                    <input type="number" id="newMedVialMg" placeholder="10">
                </div>

                <div class="form-group">
                    <label>Reconstitution Volume (ml)</label>
                    <input type="number" id="newMedVialMl" placeholder="3" step="0.1">
                </div>

                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="newMedStartDate">
                </div>

                <button class="btn btn-primary" onclick="addMedication()">Save Medication</button>
                <button class="btn btn-secondary" onclick="hideAddMedication()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // AUTHENTICATION BYPASS (Optional)
        // ==========================================
        // Set this to true to bypass authentication for single-user mode
        // When enabled, the app will automatically use the stored credentials
        // To use: Set BYPASS_AUTH = true and enter email/password below
        const BYPASS_AUTH = true;
        const BYPASS_EMAIL = 'nadiamorhakim@gmail.com';
        const BYPASS_PASSWORD = 'dreluna58';

        // ==========================================
        // SUPABASE CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://wnjpxvzvktytrwenucbu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduanB4dnp2a3R5dHJ3ZW51Y2J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MzYwNjMsImV4cCI6MjA3NzIxMjA2M30.2F8Fxp74rcMRWNjdCOg1z13AmMDIsVmH-NFTTb4Aa70';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                storage: window.localStorage,
                storageKey: 'bunnydose-auth',
                flowType: 'pkce'
            }
        });

        let currentUser = null;
        let isSignUp = false;
        let weightChart = null;
        let doseChart = null;
        let sideEffectsChart = null;
        let summaryWeightChart = null;
        let summaryDoseChart = null;
        let shotsProgressChart = null;
        let resultsWeightChart = null;
        let selectedSymptom = null;
        let isAuthHandlerRunning = false;

        // Check auth state on load - with debouncing to prevent rapid fire
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('üîê Auth state changed:', event, 'Session:', session ? 'exists' : 'null', 'isAuthHandlerRunning:', isAuthHandlerRunning);

            // Handle SIGNED_OUT event explicitly
            if (event === 'SIGNED_OUT') {
                console.log('üëã User signed out');
                currentUser = null;
                isAuthHandlerRunning = false;
                showAuth();
                return;
            }

            // Allow TOKEN_REFRESHED events through without blocking
            if (event === 'TOKEN_REFRESHED') {
                console.log('üîÑ Token refreshed, updating current user');
                if (session && session.user) {
                    currentUser = session.user;
                }
                return;
            }

            // Prevent multiple simultaneous auth handlers from running
            if (isAuthHandlerRunning) {
                console.log('‚è∏Ô∏è Auth handler already running for ' + event + ', skipping...');
                return;
            }

            // Only proceed if we have a session
            if (!session) {
                console.log('‚ö†Ô∏è No session, showing auth...');
                currentUser = null;
                showAuth();
                return;
            }

            // Lock the handler
            console.log('üîí Locking auth handler for event:', event);
            isAuthHandlerRunning = true;

            try {
                currentUser = session.user;
                console.log('üë§ Current user:', currentUser.email);
                console.log('üìß Email verified:', !!currentUser.email_confirmed_at);

                // Check if onboarding is needed by checking database
                console.log('üîç Checking if user has completed onboarding...');

                // Check if user has any medications (indicates onboarding completed)
                // Add timeout to prevent hanging
                let medications = null;
                let medError = null;

                try {
                    const queryPromise = supabase
                        .from('medications')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .limit(1);

                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Query timeout')), 5000)
                    );

                    const result = await Promise.race([queryPromise, timeoutPromise]);
                    medications = result.data;
                    medError = result.error;
                } catch (err) {
                    console.error('‚ùå Medications query error:', err);
                    medError = err;
                }

                console.log('üìù Medications check:', { medications, medError });

                // Determine if onboarding completed
                let hasCompletedOnboarding = medications && medications.length > 0;

                // If query failed, fallback to localStorage
                if (medError && !hasCompletedOnboarding) {
                    console.log('‚ö†Ô∏è Query failed, checking localStorage...');
                    const localOnboarded = localStorage.getItem('onboarded_' + currentUser.id);
                    hasCompletedOnboarding = localOnboarded === 'true';
                }

                console.log('üìù Onboarding completed:', hasCompletedOnboarding);

                if (!hasCompletedOnboarding) {
                    console.log('üéØ Showing onboarding...');
                    showOnboarding();
                } else {
                    console.log('‚úÖ Showing app...');
                    // Set localStorage for faster checks next time
                    localStorage.setItem('onboarded_' + currentUser.id, 'true');
                    showApp();
                    // Load data in background
                    loadUserData().catch(err => console.error('Error loading data:', err));
                }
            } catch (error) {
                console.error('‚ùå Error in auth state change:', error);
                showToast('Error loading app: ' + error.message, '‚ùå');
            } finally {
                // Always unlock the handler
                isAuthHandlerRunning = false;
                console.log('üîì Auth handler unlocked');
            }
        });

        // Initialize - Just check for existing session, onAuthStateChange will handle the rest
        async function init() {
            console.log('üöÄ Initializing app...');

            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('‚ùå Error getting session:', error);

                    // Try bypass auth if enabled
                    if (BYPASS_AUTH && BYPASS_EMAIL && BYPASS_PASSWORD) {
                        console.log('üîì Bypass auth enabled, attempting auto-login...');
                        try {
                            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                                email: BYPASS_EMAIL,
                                password: BYPASS_PASSWORD
                            });
                            if (authError) throw authError;
                            console.log('‚úÖ Bypass auth successful');
                            return; // Let onAuthStateChange handle the rest
                        } catch (bypassError) {
                            console.error('‚ùå Bypass auth failed:', bypassError);
                            showAuth();
                            return;
                        }
                    }

                    showAuth();
                    return;
                }

                if (session) {
                    console.log('‚úÖ Session found on init, onAuthStateChange will handle it');
                    // Don't do anything here - onAuthStateChange will handle it
                    // This prevents race conditions and duplicate work
                } else {
                    console.log('‚ö†Ô∏è No session found on init');

                    // Try bypass auth if enabled
                    if (BYPASS_AUTH && BYPASS_EMAIL && BYPASS_PASSWORD) {
                        console.log('üîì Bypass auth enabled, attempting auto-login...');
                        try {
                            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                                email: BYPASS_EMAIL,
                                password: BYPASS_PASSWORD
                            });
                            if (authError) throw authError;
                            console.log('‚úÖ Bypass auth successful');
                            return; // Let onAuthStateChange handle the rest
                        } catch (bypassError) {
                            console.error('‚ùå Bypass auth failed:', bypassError);
                            showAuth();
                            return;
                        }
                    }

                    showAuth();
                }
            } catch (error) {
                console.error('‚ùå Init error:', error);
                showAuth();
            }
        }

        // Create profile if it doesn't exist
        async function createProfile() {
            console.log('Checking profile for user:', currentUser.id);

            // Add timeout - if it takes longer than 3 seconds, just skip it
            const timeoutPromise = new Promise((resolve) => {
                setTimeout(() => {
                    console.warn('‚è±Ô∏è Profile check timeout - skipping');
                    resolve();
                }, 3000);
            });

            const profilePromise = (async () => {
                try {
                    // First, check if profile exists
                    console.log('üì° Querying profiles table...');
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('id', currentUser.id)
                        .single();

                    console.log('üì° Profile query result:', { data, error });

                    if (error && error.code === 'PGRST116') {
                        // Profile doesn't exist (PGRST116 = no rows returned)
                        console.log('Profile not found, attempting to create...');
                        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                        const { data: newProfile, error: insertError } = await supabase.from('profiles').insert({
                            id: currentUser.id,
                            name: currentUser.email.split('@')[0],
                            username: username,
                            email: currentUser.email
                        }).select().single();

                        if (insertError) {
                            // Check if error is because profile already exists (race condition with trigger)
                            if (insertError.code === '23505') {
                                console.log('‚ö†Ô∏è Profile already exists (created by trigger), continuing...');
                                return; // Profile exists, all good
                            }
                            console.error('‚ùå Profile creation failed:', insertError);
                            // Don't throw - just continue
                            return;
                        }
                        console.log('‚úì Profile created successfully:', newProfile);
                    } else if (error) {
                        console.warn('‚ö†Ô∏è Error checking profile (but continuing):', error);
                    } else {
                        console.log('‚úì Profile already exists');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Profile check/creation had an issue (continuing anyway):', error);
                }
            })();

            // Race between profile creation and timeout
            await Promise.race([profilePromise, timeoutPromise]);
            console.log('‚úÖ Profile check complete (or timed out)');
        }

        // Onboarding Functions
        function showOnboarding() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('verifyScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('onboardingModal').classList.add('show');
        }

        function nextOnboardingStep(step) {
            // Hide all steps
            for (let i = 1; i <= 5; i++) {
                document.getElementById('onboardingStep' + i).classList.add('hidden');
            }
            // Show target step
            document.getElementById('onboardingStep' + step).classList.remove('hidden');

            // Set default date to today when entering step 2
            if (step === 2) {
                const dateInput = document.getElementById('onboardingStartDate');
                if (dateInput && !dateInput.value) {
                    dateInput.valueAsDate = new Date();
                }
            }

            // Initialize slider colors when entering step 3
            if (step === 3) {
                const sliderValue = document.getElementById('onboardingWeeklyLoss').value;
                updateWeeklyLossDisplay(sliderValue);
            }
        }

        function prevOnboardingStep(step) {
            nextOnboardingStep(step);
        }

        // Track current unit system
        let currentUnit = 'metric';

        function switchOnboardingUnit(unit) {
            currentUnit = unit;

            // Update button styles
            const metricBtn = document.getElementById('metricBtn');
            const imperialBtn = document.getElementById('imperialBtn');

            if (unit === 'metric') {
                metricBtn.classList.add('active');
                imperialBtn.classList.remove('active');
                metricBtn.style.background = 'linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%)';
                metricBtn.style.color = 'white';
                imperialBtn.style.background = 'transparent';
                imperialBtn.style.color = 'var(--text-secondary)';

                // Update labels
                document.getElementById('heightLabel').textContent = 'Height (cm)';
                document.getElementById('startWeightLabel').textContent = 'Weight on Start Date (kg)';
                document.getElementById('currentWeightLabel').textContent = 'Current Weight (kg)';
                document.getElementById('goalWeightLabel').textContent = 'Goal Weight (kg)';
                document.getElementById('weeklyLossUnit').textContent = 'kg';
                document.getElementById('idealRangeText').textContent = '0.5-0.7 kg per week is ideal for sustainable weight loss';

                // Update placeholders
                document.getElementById('onboardingHeight').placeholder = '170';
                document.getElementById('onboardingStartWeight').placeholder = '86.7';
                document.getElementById('onboardingCurrentWeight').placeholder = '85.6';
                document.getElementById('onboardingGoalWeight').placeholder = '75.0';

                // Update slider range
                document.getElementById('onboardingWeeklyLoss').min = '0.3';
                document.getElementById('onboardingWeeklyLoss').max = '1.0';
                document.getElementById('onboardingWeeklyLoss').step = '0.1';
                document.getElementById('onboardingWeeklyLoss').value = '0.5';
            } else {
                imperialBtn.classList.add('active');
                metricBtn.classList.remove('active');
                imperialBtn.style.background = 'linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%)';
                imperialBtn.style.color = 'white';
                metricBtn.style.background = 'transparent';
                metricBtn.style.color = 'var(--text-secondary)';

                // Update labels
                document.getElementById('heightLabel').textContent = 'Height (inches)';
                document.getElementById('startWeightLabel').textContent = 'Weight on Start Date (lbs)';
                document.getElementById('currentWeightLabel').textContent = 'Current Weight (lbs)';
                document.getElementById('goalWeightLabel').textContent = 'Goal Weight (lbs)';
                document.getElementById('weeklyLossUnit').textContent = 'lbs';
                document.getElementById('idealRangeText').textContent = '1.1-1.5 lbs per week is ideal for sustainable weight loss';

                // Update placeholders
                document.getElementById('onboardingHeight').placeholder = '67';
                document.getElementById('onboardingStartWeight').placeholder = '191';
                document.getElementById('onboardingCurrentWeight').placeholder = '189';
                document.getElementById('onboardingGoalWeight').placeholder = '165';

                // Update slider range (convert kg to lbs)
                document.getElementById('onboardingWeeklyLoss').min = '0.66'; // 0.3 kg
                document.getElementById('onboardingWeeklyLoss').max = '2.2'; // 1.0 kg
                document.getElementById('onboardingWeeklyLoss').step = '0.22';
                document.getElementById('onboardingWeeklyLoss').value = '1.1'; // 0.5 kg
                updateWeeklyLossDisplay('1.1');
            }

            // Clear existing values to avoid confusion
            document.getElementById('onboardingHeight').value = '';
            document.getElementById('onboardingStartWeight').value = '';
            document.getElementById('onboardingCurrentWeight').value = '';
            document.getElementById('onboardingGoalWeight').value = '';

            // Recalculate BMI
            calculateOnboardingBMI();

            // Update slider label colors after unit switch
            const currentSliderValue = document.getElementById('onboardingWeeklyLoss').value;
            updateWeeklyLossDisplay(currentSliderValue);
        }

        function updateWeeklyLossDisplay(value) {
            document.getElementById('weeklyLossValue').textContent = parseFloat(value).toFixed(1);

            // Update slider label colors based on value
            const slowLabel = document.getElementById('slowLabel');
            const healthyLabel = document.getElementById('healthyLabel');
            const fastLabel = document.getElementById('fastLabel');

            if (!slowLabel || !healthyLabel || !fastLabel) return;

            // Reset all labels to default color
            slowLabel.style.color = 'var(--text-secondary)';
            slowLabel.style.fontWeight = '600';
            slowLabel.style.background = '';
            slowLabel.style.webkitBackgroundClip = '';
            slowLabel.style.webkitTextFillColor = '';
            slowLabel.style.backgroundClip = '';

            healthyLabel.style.color = 'var(--text-secondary)';
            healthyLabel.style.fontWeight = '600';
            healthyLabel.style.background = '';
            healthyLabel.style.webkitBackgroundClip = '';
            healthyLabel.style.webkitTextFillColor = '';
            healthyLabel.style.backgroundClip = '';

            fastLabel.style.color = 'var(--text-secondary)';
            fastLabel.style.fontWeight = '600';
            fastLabel.style.background = '';
            fastLabel.style.webkitBackgroundClip = '';
            fastLabel.style.webkitTextFillColor = '';
            fastLabel.style.backgroundClip = '';

            const numValue = parseFloat(value);

            // Determine which range (works for both metric and imperial)
            const min = parseFloat(document.getElementById('onboardingWeeklyLoss').min);
            const max = parseFloat(document.getElementById('onboardingWeeklyLoss').max);
            const range = max - min;
            const lowThreshold = min + (range * 0.3); // First 30%
            const highThreshold = min + (range * 0.7); // Last 30%

            if (numValue <= lowThreshold) {
                // Slow range - yellow
                slowLabel.style.color = '#f59e0b';
                slowLabel.style.fontWeight = '700';
            } else if (numValue >= highThreshold) {
                // Fast range - red gradient
                fastLabel.style.background = 'linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%)';
                fastLabel.style.webkitBackgroundClip = 'text';
                fastLabel.style.webkitTextFillColor = 'transparent';
                fastLabel.style.backgroundClip = 'text';
                fastLabel.style.fontWeight = '700';
            } else {
                // Healthy range - green
                healthyLabel.style.color = '#34c759';
                healthyLabel.style.fontWeight = '700';
            }
        }

        function calculateOnboardingBMI() {
            let height = parseFloat(document.getElementById('onboardingHeight').value);
            let startWeight = parseFloat(document.getElementById('onboardingStartWeight').value);
            let currentWeight = parseFloat(document.getElementById('onboardingCurrentWeight').value);
            let goalWeight = parseFloat(document.getElementById('onboardingGoalWeight').value);

            // Convert to metric if imperial
            if (currentUnit === 'imperial') {
                // Convert inches to cm
                height = height * 2.54;
                // Convert lbs to kg
                startWeight = startWeight * 0.453592;
                currentWeight = currentWeight * 0.453592;
                goalWeight = goalWeight * 0.453592;
            }

            if (height && startWeight && currentWeight) {
                const heightM = height / 100;
                const startBMI = (startWeight / (heightM * heightM)).toFixed(1);
                const currentBMI = (currentWeight / (heightM * heightM)).toFixed(1);

                document.getElementById('startBMI').textContent = startBMI;
                document.getElementById('currentBMI').textContent = currentBMI;

                // BMI Category
                let category = '';
                const bmi = parseFloat(currentBMI);
                if (bmi < 18.5) category = 'Underweight';
                else if (bmi < 25) category = 'Normal weight';
                else if (bmi < 30) category = 'Overweight';
                else category = 'Obese';

                document.getElementById('bmiCategory').textContent = `Current category: ${category}`;
                document.getElementById('bmiDisplay').style.display = 'block';
            } else {
                document.getElementById('bmiDisplay').style.display = 'none';
            }

            if (height && goalWeight) {
                const heightM = height / 100;
                const goalBMI = (goalWeight / (heightM * heightM)).toFixed(1);
                document.getElementById('goalBMI').textContent = goalBMI;
                document.getElementById('goalBMIDisplay').style.display = 'block';
            } else {
                document.getElementById('goalBMIDisplay').style.display = 'none';
            }
        }

        async function completeOnboarding() {
            // Validate inputs
            const medicationType = document.getElementById('onboardingMedicationType').value;
            const startDate = document.getElementById('onboardingStartDate').value;
            const startDose = parseFloat(document.getElementById('onboardingStartDose').value);
            const vialMg = parseFloat(document.getElementById('onboardingVialMg').value);
            const vialMl = parseFloat(document.getElementById('onboardingVialMl').value);
            let height = parseFloat(document.getElementById('onboardingHeight').value);
            let startWeight = parseFloat(document.getElementById('onboardingStartWeight').value);
            let currentWeight = parseFloat(document.getElementById('onboardingCurrentWeight').value);
            let goalWeight = parseFloat(document.getElementById('onboardingGoalWeight').value);
            let weeklyLoss = parseFloat(document.getElementById('onboardingWeeklyLoss').value);
            const frequency = parseFloat(document.getElementById('onboardingFrequency').value);

            if (!medicationType || !startDate || !height || !startWeight || !goalWeight || !weeklyLoss) {
                showToast('Please fill in all required fields', '‚ö†Ô∏è');
                return;
            }

            // Convert to metric if imperial (for database storage)
            if (currentUnit === 'imperial') {
                height = height * 2.54; // inches to cm
                startWeight = startWeight * 0.453592; // lbs to kg
                currentWeight = currentWeight * 0.453592;
                goalWeight = goalWeight * 0.453592;
                weeklyLoss = weeklyLoss * 0.453592;
            }

            // Calculate goal date
            const totalToLose = currentWeight - goalWeight;
            const weeksToGoal = Math.ceil(totalToLose / weeklyLoss);
            const goalDate = new Date();
            goalDate.setDate(goalDate.getDate() + (weeksToGoal * 7));

            // Update summary
            document.getElementById('summaryStartWeight').textContent = startWeight.toFixed(1) + ' kg';
            document.getElementById('summaryGoalWeight').textContent = goalWeight.toFixed(1) + ' kg';
            document.getElementById('summaryTotalLoss').textContent = totalToLose.toFixed(1) + ' kg';
            document.getElementById('summaryWeeklyLoss').textContent = weeklyLoss.toFixed(1) + ' kg/week';
            document.getElementById('onboardingGoalDate').textContent = goalDate.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('onboardingWeeksToGoal').textContent = weeksToGoal + ' weeks to go';

            // Store onboarding data
            const onboardingData = {
                medicationType,
                startDate,
                startDose,
                vialMg,
                vialMl,
                height,
                startWeight,
                currentWeight,
                goalWeight,
                weeklyLoss,
                frequency,
                goalDate: goalDate.toISOString()
            };

            localStorage.setItem('onboardingData_' + currentUser.id, JSON.stringify(onboardingData));
            localStorage.setItem('startWeight', startWeight);
            localStorage.setItem('weightGoal', goalWeight);

            // Show summary
            nextOnboardingStep(5);
        }

        async function finishOnboarding() {
            console.log('Starting finishOnboarding...');

            const onboardingData = JSON.parse(localStorage.getItem('onboardingData_' + currentUser.id));
            console.log('Onboarding data:', onboardingData);

            if (!onboardingData) {
                showToast('Error: Onboarding data not found', '‚ùå');
                return;
            }

            showToast('Setting up your account...', '‚è≥');

            try {
                console.log('Creating medication...');

                // Determine medication type based on selection
                let medType = 'GLP-1';
                if (onboardingData.medicationType === 'Tirzepatide') {
                    medType = 'GLP-1/GIP';
                } else if (onboardingData.medicationType === 'Retatrutide') {
                    medType = 'GLP-1/GIP/Glucagon';
                } else if (onboardingData.medicationType === 'Semaglutide') {
                    medType = 'GLP-1';
                }

                // Create medication
                const { data: med, error: medError } = await supabase.from('medications').insert({
                    user_id: currentUser.id,
                    name: onboardingData.medicationType || 'Other',
                    type: medType,
                    vial_concentration_mg: onboardingData.vialMg,
                    vial_volume_ml: onboardingData.vialMl,
                    start_date: onboardingData.startDate,
                    is_active: true
                }).select().single();

                if (medError) {
                    console.error('Medication error:', medError);
                    throw medError;
                }
                console.log('Medication created:', med);

                console.log('Adding starting weight entry...');
                // Add starting weight entry
                const { error: startWeightError } = await supabase.from('weight_entries').insert({
                    user_id: currentUser.id,
                    date: onboardingData.startDate,
                    weight_kg: onboardingData.startWeight,
                    notes: 'Starting weight'
                });

                if (startWeightError) {
                    console.error('Start weight error:', startWeightError);
                    throw startWeightError;
                }

                // Add current weight if different
                if (onboardingData.currentWeight !== onboardingData.startWeight) {
                    console.log('Adding current weight entry...');
                    const { error: currentWeightError } = await supabase.from('weight_entries').insert({
                        user_id: currentUser.id,
                        date: new Date().toISOString().split('T')[0],
                        weight_kg: onboardingData.currentWeight,
                        notes: 'Current weight'
                    });

                    if (currentWeightError) {
                        console.error('Current weight error:', currentWeightError);
                        throw currentWeightError;
                    }
                }

                console.log('Creating titration schedule...');
                // Create default titration schedule
                await createDefaultTitrationSchedule(med.id, onboardingData.frequency);

                console.log('Updating profile with goals...');
                // Update profile with goal information
                const { error: profileError } = await supabase.from('profiles').update({
                    height_cm: onboardingData.height,
                    goal_weight_kg: onboardingData.goalWeight,
                    weekly_loss_target_kg: onboardingData.weeklyLoss,
                    goal_date: onboardingData.goalDate.split('T')[0]
                }).eq('id', currentUser.id);

                if (profileError) {
                    console.error('Profile update error:', profileError);
                    // Don't throw - this is not critical
                }

                // Mark as onboarded
                localStorage.setItem('onboarded_' + currentUser.id, 'true');
                console.log('Onboarding completed successfully!');

                // Close onboarding and show app
                document.getElementById('onboardingModal').classList.remove('show');
                showApp();
                await loadUserData();

                showToast('Welcome to BunnyDose! üê∞', 'üéâ');

            } catch (error) {
                console.error('Onboarding error:', error);
                showToast('Error: ' + (error.message || 'Failed to complete setup'), '‚ùå');
            }
        }

        async function createDefaultTitrationSchedule(medicationId, frequency) {
            // Week 1-2: 1mg
            await supabase.from('titration_schedules').insert([
                { user_id: currentUser.id, medication_id: medicationId, week_number: 1, dose_mg: 1, frequency_days: frequency, notes: 'Starting dose' },
                { user_id: currentUser.id, medication_id: medicationId, week_number: 2, dose_mg: 1, frequency_days: frequency, notes: 'Maintain starting dose' }
            ]);

            // Week 3-5: 2mg split
            await supabase.from('titration_schedules').insert([
                { user_id: currentUser.id, medication_id: medicationId, week_number: 3, dose_mg: 2, frequency_days: frequency, notes: 'Increase to 2mg (split if needed)' },
                { user_id: currentUser.id, medication_id: medicationId, week_number: 4, dose_mg: 2, frequency_days: frequency, notes: 'Maintain 2mg' },
                { user_id: currentUser.id, medication_id: medicationId, week_number: 5, dose_mg: 2, frequency_days: frequency, notes: 'Maintain 2mg' }
            ]);

            // Week 6+: Gradual increase
            await supabase.from('titration_schedules').insert([
                { user_id: currentUser.id, medication_id: medicationId, week_number: 6, dose_mg: 3, frequency_days: frequency, notes: 'Increase as tolerated' },
                { user_id: currentUser.id, medication_id: medicationId, week_number: 8, dose_mg: 4, frequency_days: frequency, notes: 'Increase as tolerated' },
                { user_id: currentUser.id, medication_id: medicationId, week_number: 10, dose_mg: 5, frequency_days: frequency, notes: 'Increase as tolerated' }
            ]);
        }

        // Titration Schedule Functions
        async function openTitrationModal() {
            const { data: meds } = await supabase
                .from('medications')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .limit(1);

            if (!meds || meds.length === 0) {
                showToast('Please add a medication first', '‚ö†Ô∏è');
                return;
            }

            const medicationId = meds[0].id;

            const { data: schedule } = await supabase
                .from('titration_schedules')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('medication_id', medicationId)
                .order('week_number', { ascending: true });

            displayTitrationSchedule(schedule || []);
            document.getElementById('titrationModal').classList.add('show');
        }

        function closeTitrationModal() {
            document.getElementById('titrationModal').classList.remove('show');
        }

        function displayTitrationSchedule(schedule) {
            const list = document.getElementById('titrationScheduleList');

            if (schedule.length === 0) {
                list.innerHTML = '<div class="empty-state">No schedule set up yet</div>';
                return;
            }

            list.innerHTML = schedule.map(week => `
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #2d3748;">Week ${week.week_number}</strong>
                        <span style="color: #667eea; font-weight: 700; font-size: 18px;">${week.dose_mg}mg</span>
                    </div>
                    <div style="font-size: 13px; color: #718096; margin-bottom: 5px;">
                        Every ${week.frequency_days} days
                    </div>
                    ${week.notes ? `<div style="font-size: 13px; color: #4a5568;">${week.notes}</div>` : ''}
                </div>
            `).join('');
        }

        async function calculateNextDose() {
            // Get last dose
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(1);

            if (!doses || doses.length === 0) {
                return null;
            }

            const lastDose = doses[0];
            const lastDoseDate = new Date(lastDose.date);

            // Get medication and start date
            const { data: med } = await supabase
                .from('medications')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .limit(1)
                .single();

            if (!med) return null;

            const startDate = new Date(med.start_date);
            const now = new Date();

            // Calculate which week we're in
            const daysSinceStart = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
            const currentWeek = Math.floor(daysSinceStart / 7) + 1;

            // Get schedule for current week
            const { data: schedule } = await supabase
                .from('titration_schedules')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('medication_id', med.id)
                .lte('week_number', currentWeek)
                .order('week_number', { ascending: false })
                .limit(1);

            if (!schedule || schedule.length === 0) {
                // Default: use last dose info
                const frequency = 3.5; // default
                const nextDate = new Date(lastDoseDate);
                nextDate.setDate(nextDate.getDate() + Math.ceil(frequency));
                return {
                    date: nextDate,
                    dose: lastDose.dose_mg,
                    week: currentWeek
                };
            }

            const weekSchedule = schedule[0];
            const nextDate = new Date(lastDoseDate);
            nextDate.setDate(nextDate.getDate() + Math.ceil(weekSchedule.frequency_days));

            return {
                date: nextDate,
                dose: weekSchedule.dose_mg,
                week: currentWeek
            };
        }

        function showAuth() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('verifyScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        async function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('verifyScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');

            // Load user profile (including measurement_unit)
            await loadUserProfile();

            // Load the summary page by default
            loadSummaryPage();
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profile) {
                    currentUser.profile = profile;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function showVerify(email) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('verifyScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('verifyEmail').textContent = email;
        }

        function backToSignIn() {
            isSignUp = false;
            document.getElementById('authTitle').textContent = 'Welcome Back';
            document.getElementById('authButton').textContent = 'Sign In';
            document.getElementById('toggleAuthLink').textContent = 'Create an account instead';

            // Reset username field to hidden
            document.getElementById('usernameGroup').style.display = 'none';
            document.getElementById('emailLabel').textContent = 'Email or Username';
            document.getElementById('authEmail').placeholder = 'your@email.com or username';
            document.getElementById('authEmail').type = 'text';

            // Hide forgot password screen if it's showing
            document.getElementById('forgotPasswordScreen').classList.add('hidden');

            showAuth();
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('authTitle').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
            document.getElementById('authButton').textContent = isSignUp ? 'Sign Up' : 'Sign In';
            document.getElementById('toggleAuthLink').textContent = isSignUp ? 'Already have an account? Sign in' : 'Create an account instead';

            // Show/hide fields based on mode
            const usernameGroup = document.getElementById('usernameGroup');
            const emailLabel = document.getElementById('emailLabel');
            const emailInput = document.getElementById('authEmail');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');

            if (isSignUp) {
                // Sign Up mode - show both email and username
                usernameGroup.style.display = 'block';
                emailLabel.textContent = 'Email';
                emailInput.placeholder = 'your@email.com';
                emailInput.type = 'email';
                forgotPasswordLink.style.display = 'none';
            } else {
                // Sign In mode - email or username
                usernameGroup.style.display = 'none';
                emailLabel.textContent = 'Email or Username';
                emailInput.placeholder = 'your@email.com or username';
                emailInput.type = 'text';
                forgotPasswordLink.style.display = 'block';
            }
        }

        async function handleAuth() {
            const emailOrUsername = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const username = isSignUp ? document.getElementById('authUsername').value.trim() : '';

            if (!emailOrUsername || !password) {
                showToast('Please enter email and password', '‚ö†Ô∏è');
                return;
            }

            if (isSignUp && !username) {
                showToast('Please enter a username', '‚ö†Ô∏è');
                return;
            }

            // Disable button to prevent multiple clicks
            const submitBtn = document.querySelector('.btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Please wait...';

            try {
                if (isSignUp) {
                    console.log('üìù Attempting sign up...');
                    const { data, error } = await supabase.auth.signUp({
                        email: emailOrUsername,
                        password,
                        options: {
                            emailRedirectTo: window.location.origin + '/confirm.html',
                            data: {
                                username: username
                            }
                        }
                    });
                    if (error) {
                        console.error('‚ùå Sign up error:', error);
                        throw error;
                    }
                    console.log('‚úÖ Sign up success:', data);
                    showVerify(emailOrUsername);
                    // Clear form
                    document.getElementById('authEmail').value = '';
                    document.getElementById('authPassword').value = '';
                    document.getElementById('authUsername').value = '';
                } else {
                    console.log('üîê Attempting sign in...');
                    showToast('Signing in...', '‚è≥');

                    // Check if input is email or username
                    let loginEmail = emailOrUsername;
                    if (!emailOrUsername.includes('@')) {
                        // It's a username, look up the email
                        console.log('üîç Looking up username:', emailOrUsername);
                        const { data: profile, error: lookupError } = await supabase
                            .from('profiles')
                            .select('email')
                            .eq('username', emailOrUsername)
                            .single();

                        console.log('Profile lookup result:', { profile, lookupError });

                        if (lookupError || !profile || !profile.email) {
                            console.error('‚ùå Username lookup failed:', lookupError);
                            throw new Error('Username not found or not linked to an email. Please use your email address to sign in.');
                        }
                        loginEmail = profile.email;
                        console.log('‚úÖ Found email for username:', loginEmail);
                    }

                    console.log('üìß Attempting sign in with email:', loginEmail);
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: loginEmail,
                        password
                    });

                    if (error) {
                        console.error('‚ùå Sign in error:', error);
                        throw error;
                    }

                    console.log('‚úÖ Sign in success:', data);
                    console.log('üìß Email verified:', !!data.user?.email_confirmed_at);

                    // Don't navigate here - let onAuthStateChange handle it
                    console.log('‚úÖ Sign in complete, waiting for auth handler...');
                    showToast('Signing in...', '‚è≥');

                    // The button will be re-enabled by the finally block
                    // The onAuthStateChange listener will handle navigation
                }
            } catch (error) {
                console.error('‚ùå Auth error:', error);
                showToast(error.message, '‚ùå');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } finally {
                // Re-enable button after 1 second if not redirected
                setTimeout(() => {
                    if (submitBtn && submitBtn.disabled) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        console.log('üîì Button re-enabled after timeout');
                    }
                }, 1500); // Reduced from 3000ms to 1500ms
            }
        }

        function showForgotPassword() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('forgotPasswordScreen').classList.remove('hidden');
        }

        async function handleForgotPassword() {
            const email = document.getElementById('resetEmail').value.trim();

            if (!email) {
                showToast('Please enter your email', '‚ö†Ô∏è');
                return;
            }

            const submitBtn = document.querySelector('#forgotPasswordScreen .btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password.html'
                });

                if (error) {
                    console.error('‚ùå Password reset error:', error);
                    throw error;
                }

                showToast('Password reset link sent! Check your email.', '‚úÖ');
                document.getElementById('resetEmail').value = '';
                setTimeout(() => {
                    backToSignIn();
                }, 2000);
            } catch (error) {
                console.error('‚ùå Reset password error:', error);
                showToast(error.message, '‚ùå');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
        }

        // Export to Excel
        async function exportToExcel() {
            try {
                showToast('Preparing export...', 'üìä');

                // Fetch all data
                const [medications, doses, weights, sideEffects, titrationSchedule] = await Promise.all([
                    supabase.from('medications').select('*').eq('user_id', currentUser.id),
                    supabase.from('dose_entries').select('*').eq('user_id', currentUser.id).order('date', { ascending: false }),
                    supabase.from('weight_entries').select('*').eq('user_id', currentUser.id).order('date', { ascending: false }),
                    supabase.from('side_effects').select('*').eq('user_id', currentUser.id).order('date', { ascending: false }),
                    supabase.from('titration_schedules').select('*').eq('user_id', currentUser.id).order('week_number', { ascending: true })
                ]);

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Medications Sheet
                if (medications.data && medications.data.length > 0) {
                    const medsData = medications.data.map(m => ({
                        'Name': m.name,
                        'Type': m.type,
                        'Vial Concentration (mg)': m.vial_concentration_mg,
                        'Vial Volume (ml)': m.vial_volume_ml,
                        'Start Date': m.start_date,
                        'Active': m.is_active ? 'Yes' : 'No',
                        'Created': new Date(m.created_at).toLocaleDateString()
                    }));
                    const medsSheet = XLSX.utils.json_to_sheet(medsData);
                    XLSX.utils.book_append_sheet(wb, medsSheet, 'Medications');
                }

                // Doses Sheet
                if (doses.data && doses.data.length > 0) {
                    const dosesData = doses.data.map(d => ({
                        'Date': d.date,
                        'Dose (mg)': d.dose_mg,
                        'Units Injected': d.units_injected,
                        'Injection Site': d.injection_site,
                        'Notes': d.notes || '',
                        'Created': new Date(d.created_at).toLocaleDateString()
                    }));
                    const dosesSheet = XLSX.utils.json_to_sheet(dosesData);
                    XLSX.utils.book_append_sheet(wb, dosesSheet, 'Doses');
                }

                // Weight Entries Sheet
                if (weights.data && weights.data.length > 0) {
                    const weightsData = weights.data.map(w => ({
                        'Date': w.date,
                        'Weight (kg)': w.weight_kg,
                        'Notes': w.notes || '',
                        'Created': new Date(w.created_at).toLocaleDateString()
                    }));
                    const weightsSheet = XLSX.utils.json_to_sheet(weightsData);
                    XLSX.utils.book_append_sheet(wb, weightsSheet, 'Weight');
                }

                // Side Effects Sheet
                if (sideEffects.data && sideEffects.data.length > 0) {
                    const sideEffectsData = sideEffects.data.map(s => ({
                        'Date': s.date,
                        'Symptom': s.symptom,
                        'Severity': s.severity,
                        'Notes': s.notes || '',
                        'Created': new Date(s.created_at).toLocaleDateString()
                    }));
                    const sideEffectsSheet = XLSX.utils.json_to_sheet(sideEffectsData);
                    XLSX.utils.book_append_sheet(wb, sideEffectsSheet, 'Side Effects');
                }

                // Titration Schedule Sheet
                if (titrationSchedule.data && titrationSchedule.data.length > 0) {
                    const titrationData = titrationSchedule.data.map(t => ({
                        'Week': t.week_number,
                        'Dose (mg)': t.dose_mg,
                        'Frequency (days)': t.frequency_days,
                        'Notes': t.notes || '',
                        'Created': new Date(t.created_at).toLocaleDateString()
                    }));
                    const titrationSheet = XLSX.utils.json_to_sheet(titrationData);
                    XLSX.utils.book_append_sheet(wb, titrationSheet, 'Titration Schedule');
                }

                // Generate filename with current date
                const today = new Date().toISOString().split('T')[0];
                const filename = `BunnyDose_Export_${today}.xlsx`;

                // Generate Excel file as blob for mobile compatibility
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Check if mobile device
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                if (isMobile) {
                    // Mobile: Use download link with proper MIME type
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    showToast('Download started! Check your Downloads folder üì•', '‚úì');
                } else {
                    // Desktop: Use XLSX.writeFile for better compatibility
                    XLSX.writeFile(wb, filename);
                    showToast('Export completed! üì•', '‚úì');
                }

            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed: ' + error.message, '‚ùå');
            }
        }

        // Toast Notification
        function showToast(message, icon = '‚úì') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            toastIcon.textContent = icon;
            toastMessage.textContent = message;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Weight Conversion Helpers
        function kgToLbs(kg) {
            return kg * 2.20462;
        }

        function lbsToKg(lbs) {
            return lbs / 2.20462;
        }

        function formatWeight(weightKg, unit = null) {
            // Convert to number if it's a string
            const weight = typeof weightKg === 'string' ? parseFloat(weightKg) : weightKg;

            // Handle invalid or zero values
            if (!weight || isNaN(weight)) {
                return '0.0';
            }

            // If unit not provided, get from current user profile
            if (!unit && currentUser?.profile?.measurement_unit) {
                unit = currentUser.profile.measurement_unit;
            }
            unit = unit || 'metric';

            if (unit === 'imperial') {
                const lbs = kgToLbs(weight);
                return lbs.toFixed(1);
            }
            return weight.toFixed(1);
        }

        function getWeightUnit(unit = null) {
            if (!unit && currentUser?.profile?.measurement_unit) {
                unit = currentUser.profile.measurement_unit;
            }
            unit = unit || 'metric';
            return unit === 'imperial' ? 'lbs' : 'kg';
        }

        // Quick Actions - Bottomsheets
        function quickLogWeight() {
            openBottomsheet('weightBottomsheet');
            // Set default date and time to now
            document.getElementById('quickWeightDate').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('quickWeightTime').value = now.toTimeString().slice(0, 5);
        }

        function quickLogDose() {
            openBottomsheet('doseBottomsheet');
            // Set default date and time to now
            document.getElementById('quickDoseDate').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('quickDoseTime').value = now.toTimeString().slice(0, 5);
            // Load medications into dropdown
            loadQuickMedications();
        }

        function quickLogSideEffect() {
            openBottomsheet('sideEffectBottomsheet');
            // Set default date to today
            document.getElementById('quickSideEffectDate').valueAsDate = new Date();
        }

        function openBottomsheet(id) {
            closeAllBottomsheets();
            document.getElementById('bottomsheetOverlay').classList.add('show');
            document.getElementById(id).classList.add('show');
            // Prevent body scroll when bottomsheet is open
            document.body.style.overflow = 'hidden';
        }

        function closeBottomsheet(id) {
            document.getElementById(id).classList.remove('show');
            document.getElementById('bottomsheetOverlay').classList.remove('show');
            document.body.style.overflow = '';
        }

        function closeAllBottomsheets() {
            document.querySelectorAll('.bottomsheet').forEach(sheet => {
                sheet.classList.remove('show');
            });
            document.getElementById('bottomsheetOverlay').classList.remove('show');
            document.body.style.overflow = '';
        }

        async function loadQuickMedications() {
            const { data, error } = await supabase
                .from('medications')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            if (error) {
                console.error('Error loading medications:', error);
                return;
            }

            const select = document.getElementById('quickDoseMedication');
            select.innerHTML = '<option value="">Select medication</option>';

            data.forEach(med => {
                const option = document.createElement('option');
                option.value = med.id;
                option.textContent = med.name;
                select.appendChild(option);
            });
        }

        async function saveQuickWeight() {
            const date = document.getElementById('quickWeightDate').value;
            const weight = parseFloat(document.getElementById('quickWeightAmount').value);
            const notes = document.getElementById('quickWeightNotes').value;

            if (!date || !weight) {
                showToast('Please fill in all required fields', '‚ö†Ô∏è');
                return;
            }

            const { error } = await supabase.from('weight_entries').insert({
                user_id: currentUser.id,
                date,
                weight_kg: weight,
                notes
            });

            if (error) {
                console.error('Error saving weight:', error);
                showToast('Error saving weight: ' + error.message, '‚ùå');
                return;
            }

            showToast('Weight logged! ‚öñÔ∏è', '‚úì');
            closeBottomsheet('weightBottomsheet');
            // Clear form
            document.getElementById('quickWeightAmount').value = '';
            document.getElementById('quickWeightNotes').value = '';
            // Reload data
            await loadUserData();
        }

        async function saveQuickDose() {
            const medicationId = document.getElementById('quickDoseMedication').value;
            const date = document.getElementById('quickDoseDate').value;
            const dose = parseFloat(document.getElementById('quickDoseAmount').value);
            const units = parseInt(document.getElementById('quickDoseUnits').value);
            const site = document.getElementById('quickDoseSite').value;
            const notes = document.getElementById('quickDoseNotes').value;

            if (!medicationId || !date || !dose) {
                showToast('Please fill in all required fields', '‚ö†Ô∏è');
                return;
            }

            const { error } = await supabase.from('dose_entries').insert({
                user_id: currentUser.id,
                medication_id: medicationId,
                date,
                dose_mg: dose,
                injection_site: site,
                notes
            });

            if (error) {
                console.error('Error saving dose:', error);
                showToast('Error saving dose: ' + error.message, '‚ùå');
                return;
            }

            showToast('Dose logged! üíâ', '‚úì');
            closeBottomsheet('doseBottomsheet');
            // Clear form
            document.getElementById('quickDoseAmount').value = '';
            document.getElementById('quickDoseUnits').value = '';
            document.getElementById('quickDoseSite').value = '';
            document.getElementById('quickDoseNotes').value = '';
            // Reload data
            await loadUserData();
        }

        let quickSelectedSymptom = null;

        function selectQuickSymptom(element) {
            document.querySelectorAll('#sideEffectBottomsheet .symptom-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            quickSelectedSymptom = element.dataset.symptom;

            if (quickSelectedSymptom === 'Other') {
                document.getElementById('quickSymptomOther').classList.remove('hidden');
            } else {
                document.getElementById('quickSymptomOther').classList.add('hidden');
            }
        }

        async function saveQuickSideEffect() {
            const date = document.getElementById('quickSideEffectDate').value;
            const severity = document.getElementById('quickSideEffectSeverity').value;
            const notes = document.getElementById('quickSideEffectNotes').value;

            let symptom = quickSelectedSymptom;
            if (symptom === 'Other') {
                symptom = document.getElementById('quickSymptomOther').value;
            }

            if (!date || !symptom) {
                showToast('Please select date and symptom', '‚ö†Ô∏è');
                return;
            }

            const { error } = await supabase.from('side_effects').insert({
                user_id: currentUser.id,
                date,
                symptom,
                severity,
                notes
            });

            if (error) {
                console.error('Error saving side effect:', error);
                showToast('Error saving side effect: ' + error.message, '‚ùå');
                return;
            }

            showToast('Side effect logged! ‚ö†Ô∏è', '‚úì');
            closeBottomsheet('sideEffectBottomsheet');
            // Clear form
            quickSelectedSymptom = null;
            document.querySelectorAll('#sideEffectBottomsheet .symptom-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('quickSymptomOther').value = '';
            document.getElementById('quickSymptomOther').classList.add('hidden');
            document.getElementById('quickSideEffectNotes').value = '';
            // Reload data
            await loadUserData();
        }

        // Symptom Selection
        function selectSymptom(element) {
            document.querySelectorAll('.symptom-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            element.classList.add('selected');
            selectedSymptom = element.dataset.symptom;

            // Show custom input if "Other" is selected
            const otherInput = document.getElementById('symptomOther');
            if (selectedSymptom === 'Other') {
                otherInput.classList.remove('hidden');
                otherInput.focus();
            } else {
                otherInput.classList.add('hidden');
            }
        }

        // Weight Goal Functions
        function openGoalModal() {
            const goal = localStorage.getItem('weightGoal');
            if (goal) {
                document.getElementById('goalWeight').value = goal;
            }
            document.getElementById('goalModal').classList.add('show');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('show');
        }

        function saveGoal() {
            const goalWeight = parseFloat(document.getElementById('goalWeight').value);

            if (!goalWeight || goalWeight <= 0) {
                showToast('Please enter a valid weight goal', '‚ö†Ô∏è');
                return;
            }

            localStorage.setItem('weightGoal', goalWeight);
            closeGoalModal();
            updateGoalDisplay();
            showToast('Weight goal saved!', 'üéØ');
        }

        async function updateGoalDisplay() {
            const goalWeight = parseFloat(localStorage.getItem('weightGoal'));

            if (!goalWeight) {
                document.getElementById('goalCard').classList.add('hidden');
                return;
            }

            // Get current weight
            const { data: weights } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(1);

            if (!weights || weights.length === 0) {
                document.getElementById('goalCard').classList.add('hidden');
                return;
            }

            const currentWeight = weights[0].weight_kg;
            const startWeight = parseFloat(localStorage.getItem('startWeight') || currentWeight);

            // Store start weight if not set
            if (!localStorage.getItem('startWeight')) {
                localStorage.setItem('startWeight', currentWeight);
            }

            const totalLoss = startWeight - goalWeight;
            const currentLoss = startWeight - currentWeight;
            const remainingLoss = currentWeight - goalWeight;
            const progressPercent = Math.min(100, Math.max(0, (currentLoss / totalLoss) * 100));

            document.getElementById('goalCard').classList.remove('hidden');
            document.getElementById('goalCurrent').textContent = currentWeight.toFixed(1) + ' kg';
            document.getElementById('goalTarget').textContent = goalWeight.toFixed(1);
            document.getElementById('goalProgressFill').style.width = progressPercent + '%';

            if (remainingLoss > 0) {
                document.getElementById('goalRemaining').textContent = `${remainingLoss.toFixed(1)} kg to go`;
            } else {
                document.getElementById('goalRemaining').textContent = 'üéâ Goal achieved!';
            }
        }

        async function loadUserData() {
            console.log('Loading user data...');
            try {
                await loadMedications();
                console.log('‚úì Medications loaded');
                await loadStats();
                console.log('‚úì Stats loaded');
                // await loadNextDoseReminder(); // DISABLED - using new card design
                console.log('‚úì Next dose reminder disabled (using new design)');
                await loadRecentActivity();
                console.log('‚úì Recent activity loaded');
                await loadHistory();
                console.log('‚úì History loaded');
                await updateGoalDisplay();
                console.log('‚úì Goal display updated');
                setDefaultDate();
                console.log('‚úì All data loaded successfully');
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading data: ' + error.message, '‚ö†Ô∏è');
            }
        }

        async function loadNextDoseReminder() {
            // DISABLED - Using new card design in Summary page
            return;

            // Get last dose
            const { data: lastDose } = await supabase
                .from('dose_entries')
                .select('date, dose_mg')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(1)
                .single();

            if (!lastDose) {
                document.getElementById('nextDoseReminderCard').style.display = 'none';
                return;
            }

            // Get medication and schedule
            const { data: med } = await supabase
                .from('medications')
                .select('id, start_date')
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .limit(1)
                .single();

            if (!med) {
                document.getElementById('nextDoseReminderCard').style.display = 'none';
                return;
            }

            const startDate = new Date(med.start_date);
            const now = new Date();
            const daysSinceStart = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
            const currentWeek = Math.floor(daysSinceStart / 7) + 1;

            // Get schedule for current week
            const { data: schedule } = await supabase
                .from('titration_schedules')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('medication_id', med.id)
                .lte('week_number', currentWeek)
                .order('week_number', { ascending: false })
                .limit(1)
                .single();

            const frequency = schedule ? schedule.frequency_days : 7;
            const doseMg = schedule ? schedule.dose_mg : lastDose.dose_mg;

            const lastDoseDate = new Date(lastDose.date);
            const nextDoseDate = new Date(lastDoseDate);
            nextDoseDate.setDate(lastDoseDate.getDate() + Math.ceil(frequency));

            const daysUntil = Math.ceil((nextDoseDate - now) / (1000 * 60 * 60 * 24));

            // Update card
            document.getElementById('nextDoseReminderCard').style.display = 'block';
            document.getElementById('nextDoseReminderAmount').textContent = doseMg + 'mg';
            document.getElementById('nextDoseReminderDate').textContent = nextDoseDate.toLocaleDateString('en-GB', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });

            if (daysUntil < 0) {
                document.getElementById('nextDoseReminderDays').textContent = 'Overdue by ' + Math.abs(daysUntil) + ' days';
            } else if (daysUntil === 0) {
                document.getElementById('nextDoseReminderDays').textContent = 'Due today!';
            } else if (daysUntil === 1) {
                document.getElementById('nextDoseReminderDays').textContent = 'Due tomorrow';
            } else {
                document.getElementById('nextDoseReminderDays').textContent = 'In ' + daysUntil + ' days';
            }
        }

        async function loadMedications() {
            const { data, error } = await supabase
                .from('medications')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            if (error) {
                console.error('Error loading medications:', error);
                return;
            }

            // Populate medication select
            const select = document.getElementById('selectedMedication');
            select.innerHTML = '<option value="">Select medication</option>';

            data.forEach(med => {
                const option = document.createElement('option');
                option.value = med.id;
                option.textContent = med.name;
                select.appendChild(option);
            });

            // Display medications list
            const list = document.getElementById('medicationsList');
            if (data.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üíä</div><p>No medications yet. Add your first one!</p></div>';
            } else {
                list.innerHTML = data.map(med => `
                    <div class="medication-card">
                        <div class="medication-name">${med.name}</div>
                        <div class="medication-info">${med.type} ‚Ä¢ ${med.vial_concentration_mg}mg / ${med.vial_volume_ml}ml</div>
                        <div class="medication-info">Started: ${new Date(med.start_date).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }
        }

        async function loadStats() {
            // Load weight stats
            const { data: weights } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            if (weights && weights.length > 0) {
                const current = weights[0].weight_kg;
                const start = weights[weights.length - 1].weight_kg;
                document.getElementById('currentWeight').textContent = current.toFixed(1);

                const change = current - start;
                const changeEl = document.getElementById('weightChange');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(1)} kg`;
                changeEl.className = 'stat-change ' + (change < 0 ? 'positive' : 'negative');

                // Update weight chart
                updateWeightChart(weights.reverse());
            }

            // Load dose stats
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            if (doses && doses.length > 0) {
                document.getElementById('totalDoses').textContent = doses.length;
                document.getElementById('lastDose').textContent = `${doses[0].dose_mg}mg last`;

                // Calculate next dose with schedule
                const nextDoseInfo = await calculateNextDose();
                if (nextDoseInfo) {
                    document.getElementById('nextDoseCard').classList.remove('hidden');
                    document.getElementById('nextDoseDate').textContent = nextDoseInfo.date.toLocaleDateString('en-GB');
                    document.getElementById('nextDoseAmount').textContent = `${nextDoseInfo.dose}mg recommended`;
                    document.getElementById('currentWeek').textContent = `Week ${nextDoseInfo.week}`;
                }

                // Update dose chart
                updateDoseChart(doses.reverse());
            }

            // Load side effects stats
            const { data: sideEffects } = await supabase
                .from('side_effects')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            if (sideEffects) {
                updateSideEffectsTracker(sideEffects);
            }
        }

        function updateWeightChart(weights) {
            const ctx = document.getElementById('weightChart');

            if (weightChart) {
                weightChart.destroy();
            }

            if (weights.length === 0) {
                ctx.parentElement.innerHTML = '<div class="empty-state">No weight data yet</div>';
                return;
            }

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weights.map(w => new Date(w.date).toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Weight (kg)',
                        data: weights.map(w => w.weight_kg),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + ' kg';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDoseChart(doses) {
            const ctx = document.getElementById('doseChart');

            if (doseChart) {
                doseChart.destroy();
            }

            if (doses.length === 0) {
                ctx.parentElement.innerHTML = '<div class="empty-state">No dose data yet</div>';
                return;
            }

            doseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: doses.map(d => new Date(d.date).toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Dose (mg)',
                        data: doses.map(d => d.dose_mg),
                        backgroundColor: 'rgba(168, 85, 247, 0.8)',
                        borderColor: '#a855f7',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' mg';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSideEffectsTracker(sideEffects) {
            const summaryDiv = document.getElementById('sideEffectsSummary');
            const chartContainer = document.getElementById('sideEffectsChartContainer');

            if (sideEffects.length === 0) {
                summaryDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòä</div><p>No side effects reported</p></div>';
                chartContainer.style.display = 'none';
                return;
            }

            // Group by symptom
            const symptomCounts = {};
            const severityCounts = { mild: 0, moderate: 0, severe: 0 };

            sideEffects.forEach(se => {
                symptomCounts[se.symptom] = (symptomCounts[se.symptom] || 0) + 1;
                if (se.severity) {
                    severityCounts[se.severity]++;
                }
            });

            // Display summary
            const topSymptoms = Object.entries(symptomCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            let summaryHTML = '<div style="margin-bottom: 15px;">';
            summaryHTML += '<div style="font-size: 14px; color: #718096; margin-bottom: 10px;">Most Common:</div>';

            topSymptoms.forEach(([symptom, count]) => {
                summaryHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #2d3748;">${symptom}</span>
                        <span style="color: #667eea; font-weight: 600;">${count}x</span>
                    </div>
                `;
            });
            summaryHTML += '</div>';

            summaryDiv.innerHTML = summaryHTML;

            // Show severity chart
            chartContainer.style.display = 'block';
            const ctx = document.getElementById('sideEffectsChart');

            if (sideEffectsChart) {
                sideEffectsChart.destroy();
            }

            sideEffectsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mild', 'Moderate', 'Severe'],
                    datasets: [{
                        data: [severityCounts.mild, severityCounts.moderate, severityCounts.severe],
                        backgroundColor: ['#48bb78', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadRecentActivity() {
            const list = document.getElementById('recentActivity');

            // Get recent entries from all types
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(3);

            const { data: weights } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(3);

            const { data: sideEffects } = await supabase
                .from('side_effects')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(3);

            const allEntries = [
                ...(doses || []).map(d => ({ ...d, type: 'dose' })),
                ...(weights || []).map(w => ({ ...w, type: 'weight' })),
                ...(sideEffects || []).map(s => ({ ...s, type: 'side-effect' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            if (allEntries.length === 0) {
                list.innerHTML = '<div class="empty-state">No activity yet</div>';
                return;
            }

            list.innerHTML = allEntries.map(entry => {
                let details = '';
                if (entry.type === 'dose') {
                    details = `${entry.medications.name}: ${entry.dose_mg}mg${entry.injection_units ? ` (${entry.injection_units} units)` : ''}`;
                } else if (entry.type === 'weight') {
                    details = `Weight: ${entry.weight_kg}kg`;
                } else if (entry.type === 'side-effect') {
                    details = `${entry.symptom} (${entry.severity})`;
                }

                return `
                    <div class="entry">
                        <div class="entry-header">
                            <span class="entry-date">${new Date(entry.date).toLocaleDateString('en-GB')} ${entry.time || ''}</span>
                            <span class="entry-badge ${entry.type}">${entry.type.toUpperCase()}</span>
                        </div>
                        <div class="entry-details">${details}</div>
                    </div>
                `;
            }).join('');
        }

        let currentHistoryFilter = 'all';
        let allHistoryEntries = [];

        async function loadHistory() {
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            const { data: weights } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            const { data: sideEffects } = await supabase
                .from('side_effects')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            allHistoryEntries = [
                ...(doses || []).map(d => ({ ...d, type: 'dose' })),
                ...(weights || []).map(w => ({ ...w, type: 'weight' })),
                ...(sideEffects || []).map(s => ({ ...s, type: 'side-effect' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));

            displayHistory(currentHistoryFilter);
        }

        function filterHistory(type) {
            currentHistoryFilter = type;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            displayHistory(type);
        }

        function displayHistory(filterType) {
            const list = document.getElementById('historyList');

            // Filter entries based on type
            let filteredEntries = allHistoryEntries;
            if (filterType !== 'all') {
                filteredEntries = allHistoryEntries.filter(entry => entry.type === filterType);
            }

            if (filteredEntries.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No entries found</p></div>';
                return;
            }

            list.innerHTML = filteredEntries.map(entry => {
                let details = '';
                if (entry.type === 'dose') {
                    details = `${entry.medications.name}: ${entry.dose_mg}mg${entry.injection_units ? ` (${entry.injection_units} units)` : ''}`;
                    if (entry.injection_site) details += `<br>Site: ${entry.injection_site}`;
                } else if (entry.type === 'weight') {
                    details = `Weight: ${entry.weight_kg}kg`;
                } else if (entry.type === 'side-effect') {
                    details = `${entry.symptom} <span class="severity-${entry.severity}">(${entry.severity})</span>`;
                }
                if (entry.notes) details += `<br>${entry.notes}`;

                return `
                    <div class="entry">
                        <div class="entry-header">
                            <span class="entry-date">${new Date(entry.date).toLocaleDateString('en-GB')} ${entry.time || ''}</span>
                            <span class="entry-badge ${entry.type}">${entry.type.replace('-', ' ').toUpperCase()}</span>
                        </div>
                        <div class="entry-details">${details}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleEntryFields() {
            const type = document.getElementById('entryType').value;
            const medicationSelect = document.getElementById('medicationSelect');
            const doseFields = document.getElementById('doseFields');
            const weightFields = document.getElementById('weightFields');
            const sideEffectFields = document.getElementById('sideEffectFields');

            medicationSelect.classList.add('hidden');
            doseFields.classList.add('hidden');
            weightFields.classList.add('hidden');
            sideEffectFields.classList.add('hidden');

            if (type === 'dose') {
                medicationSelect.classList.remove('hidden');
                doseFields.classList.remove('hidden');
            } else if (type === 'weight') {
                weightFields.classList.remove('hidden');
            } else if (type === 'side-effect') {
                medicationSelect.classList.remove('hidden');
                sideEffectFields.classList.remove('hidden');
            }
        }

        async function saveEntry() {
            const type = document.getElementById('entryType').value;
            const date = document.getElementById('entryDate').value;
            const time = document.getElementById('entryTime').value;
            const notes = document.getElementById('entryNotes').value;

            if (!date) {
                showToast('Please select a date', 'üìÖ');
                return;
            }

            try {
                if (type === 'dose') {
                    const medicationId = document.getElementById('selectedMedication').value;
                    const doseMg = parseFloat(document.getElementById('doseAmount').value);
                    const units = parseInt(document.getElementById('injectionUnits').value);
                    const site = document.getElementById('injectionSite').value;

                    if (!medicationId || !doseMg) {
                        showToast('Please fill in medication and dose', '‚ö†Ô∏è');
                        return;
                    }

                    const { error } = await supabase.from('dose_entries').insert({
                        user_id: currentUser.id,
                        medication_id: medicationId,
                        date,
                        time: time || null,
                        dose_mg: doseMg,
                        injection_units: units || null,
                        injection_site: site || null,
                        notes: notes || null
                    });

                    if (error) throw error;
                    showToast('Dose logged successfully!', 'üíâ');

                } else if (type === 'weight') {
                    const weight = parseFloat(document.getElementById('weightAmount').value);

                    if (!weight) {
                        showToast('Please enter weight', '‚ö†Ô∏è');
                        return;
                    }

                    const { error } = await supabase.from('weight_entries').insert({
                        user_id: currentUser.id,
                        date,
                        time: time || null,
                        weight_kg: weight,
                        notes: notes || null
                    });

                    if (error) throw error;
                    showToast('Weight logged successfully!', '‚öñÔ∏è');

                } else if (type === 'side-effect') {
                    const medicationId = document.getElementById('selectedMedication').value;
                    let symptom = selectedSymptom;

                    // If "Other" is selected, get custom symptom
                    if (symptom === 'Other') {
                        symptom = document.getElementById('symptomOther').value;
                    }

                    const severity = document.getElementById('severity').value;

                    if (!medicationId || !symptom) {
                        showToast('Please select medication and symptom', '‚ö†Ô∏è');
                        return;
                    }

                    const { error } = await supabase.from('side_effects').insert({
                        user_id: currentUser.id,
                        medication_id: medicationId,
                        date,
                        symptom,
                        severity,
                        notes: notes || null
                    });

                    if (error) throw error;
                    showToast('Side effect logged', '‚ö†Ô∏è');
                }

                // Clear form
                document.getElementById('entryDate').value = '';
                document.getElementById('entryTime').value = '';
                document.getElementById('doseAmount').value = '';
                document.getElementById('injectionUnits').value = '';
                document.getElementById('injectionSite').value = '';
                document.getElementById('weightAmount').value = '';
                document.getElementById('symptomOther').value = '';
                document.getElementById('entryNotes').value = '';

                // Clear symptom selection
                document.querySelectorAll('.symptom-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedSymptom = null;

                await loadUserData();
                switchTab('dashboard');

            } catch (error) {
                showToast('Error: ' + error.message, '‚ùå');
            }
        }

        function calculateDose() {
            const vialMg = parseFloat(document.getElementById('calcVialMg').value);
            const vialMl = parseFloat(document.getElementById('calcVialMl').value);
            const desiredDose = parseFloat(document.getElementById('calcDesiredDose').value);

            if (!vialMg || !vialMl || !desiredDose) {
                showToast('Please fill in all fields', '‚ö†Ô∏è');
                return;
            }

            const concentration = vialMg / vialMl; // mg per ml
            const mlNeeded = desiredDose / concentration;
            const unitsNeeded = Math.round(mlNeeded * 100); // 100 units = 1ml

            document.getElementById('calculatedUnits').textContent = unitsNeeded;
            document.getElementById('calculatorResult').classList.remove('hidden');
        }

        function showAddMedication() {
            document.getElementById('addMedicationForm').classList.remove('hidden');
            setDefaultDate();
        }

        function hideAddMedication() {
            document.getElementById('addMedicationForm').classList.add('hidden');
        }

        async function addMedication() {
            const name = document.getElementById('newMedName').value;
            const type = document.getElementById('newMedType').value;
            const vialMg = parseFloat(document.getElementById('newMedVialMg').value);
            const vialMl = parseFloat(document.getElementById('newMedVialMl').value);
            const startDate = document.getElementById('newMedStartDate').value;

            if (!name || !type || !vialMg || !vialMl || !startDate) {
                showToast('Please fill in all fields', '‚ö†Ô∏è');
                return;
            }

            try {
                const { error } = await supabase.from('medications').insert({
                    user_id: currentUser.id,
                    name,
                    type,
                    vial_concentration_mg: vialMg,
                    vial_volume_ml: vialMl,
                    start_date: startDate,
                    is_active: true
                });

                if (error) throw error;

                showToast('Medication added successfully!', 'üíä');
                hideAddMedication();
                await loadMedications();

                // Clear form
                document.getElementById('newMedVialMg').value = '';
                document.getElementById('newMedVialMl').value = '';
                document.getElementById('newMedStartDate').value = '';

            } catch (error) {
                showToast('Error: ' + error.message, '‚ùå');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabs = document.querySelectorAll('.tab');
            const tabMap = { dashboard: 0, reta: 1, log: 2, calculator: 3, history: 4, meds: 5 };

            tabs[tabMap[tab]].classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            // Load Reta data when tab is opened
            if (tab === 'reta') {
                loadRetaData();
            }
        }

        // New Page Switching Function for Bottom Navigation
        function switchPage(pageName) {
            console.log('üîÑ Switching to page:', pageName);

            // Remove active class from all pages and nav items
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Add active class to selected page and nav item
            const pageId = pageName + 'Page';
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
            }

            // Find and activate the corresponding nav item
            const navItems = document.querySelectorAll('.nav-item');
            const pageMap = { summary: 0, shots: 1, results: 2, calendar: 3, settings: 4 };
            if (navItems[pageMap[pageName]]) {
                navItems[pageMap[pageName]].classList.add('active');
            }

            // Load page content
            switch(pageName) {
                case 'summary':
                    loadSummaryPage();
                    break;
                case 'shots':
                    loadShotsPage();
                    break;
                case 'results':
                    loadResultsPage();
                    break;
                case 'calendar':
                    loadCalendarPage();
                    break;
                case 'settings':
                    loadSettingsPage();
                    break;
            }
        }

        // Summary Page Loader
        async function loadSummaryPage() {
            const container = document.getElementById('summaryContent');
            if (!container) return;

            // Get all data
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            const { data: weights } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: true });

            // Get profile with goal weight
            const { data: profile } = await supabase
                .from('profiles')
                .select('goal_weight_kg')
                .eq('id', currentUser.id)
                .single();

            const totalShots = doses ? doses.length : 0;
            const lastDose = doses && doses.length > 0 ? doses[0] : null;

            // Get weight stats
            const currentWeight = weights && weights.length > 0 ? weights[weights.length - 1].weight_kg : 0;
            const startWeight = weights && weights.length > 0 ? weights[0].weight_kg : 0;
            const totalWeightLoss = startWeight - currentWeight;
            const goalWeight = profile?.goal_weight_kg || null;
            const weightToGo = goalWeight ? (currentWeight - goalWeight).toFixed(1) : null;

            // Calculate next dose
            let nextDoseHtml = '';
            if (lastDose) {
                const lastDoseDate = new Date(lastDose.date);
                const { data: medication } = await supabase
                    .from('medications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (medication) {
                    const frequency = 7; // Default weekly
                    const nextDoseDate = new Date(lastDoseDate);
                    nextDoseDate.setDate(lastDoseDate.getDate() + frequency);

                    const now = new Date();
                    const daysUntil = Math.ceil((nextDoseDate - now) / (1000 * 60 * 60 * 24));

                    let daysText = '';
                    if (daysUntil < 0) {
                        daysText = `Overdue by ${Math.abs(daysUntil)} days`;
                    } else if (daysUntil === 0) {
                        daysText = 'Due today!';
                    } else if (daysUntil === 1) {
                        daysText = 'Due tomorrow';
                    } else {
                        daysText = `In ${daysUntil} days`;
                    }

                    nextDoseHtml = `
                        <div class="ios-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;"><i data-lucide="syringe" style="width: 14px; height: 14px;"></i> Next Scheduled Shot</div>
                                    <div style="font-size: 24px; font-weight: 700;">${lastDose.dose_mg}mg</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 16px; font-weight: 600;">${nextDoseDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}</div>
                                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">${daysText}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Get today's data
            const today = new Date().toISOString().split('T')[0];
            const { data: todayWeight } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', today)
                .single();

            const { data: todaySideEffects } = await supabase
                .from('side_effects')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', today);

            container.innerHTML = `
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                    <button onclick="quickLogWeight()" class="ios-card" style="border: none; padding: 20px 12px; cursor: pointer;">
                        <i data-lucide="scale" style="width: 32px; height: 32px; color: #007AFF; margin: 0 auto 8px;"></i>
                        <div class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Log Weight</div>
                    </button>
                    <button onclick="quickLogDose()" class="ios-card" style="border: none; padding: 20px 12px; cursor: pointer;">
                        <i data-lucide="syringe" style="width: 32px; height: 32px; color: #007AFF; margin: 0 auto 8px;"></i>
                        <div class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Log Shot</div>
                    </button>
                    <button onclick="quickLogSideEffect()" class="ios-card" style="border: none; padding: 20px 12px; cursor: pointer;">
                        <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: #007AFF; margin: 0 auto 8px;"></i>
                        <div class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Side Effect</div>
                    </button>
                </div>

                ${goalWeight ? `
                <div class="ios-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">Current Weight</div>
                            <div style="font-size: 32px; font-weight: 700;">${formatWeight(currentWeight)}<span style="font-size: 20px; opacity: 0.9;">${getWeightUnit()}</span></div>
                            <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${formatWeight(totalWeightLoss)}${getWeightUnit()} lost</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">To Go</div>
                            <div style="font-size: 28px; font-weight: 700;">${formatWeight(Math.abs(currentWeight - goalWeight))}<span style="font-size: 18px; opacity: 0.9;">${getWeightUnit()}</span></div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Goal: ${formatWeight(goalWeight)}${getWeightUnit()}</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${nextDoseHtml}

                <div style="margin-bottom: 20px;">
                    <h2 class="ios-card-header" style="font-size: 22px; margin-bottom: 12px;">Today, ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long' })}</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="activity" style="width: 14px; height: 14px;"></i> Current</div>
                            <div class="stat-value">${formatWeight(currentWeight)}<span style="font-size: 16px; color: #8e8e93;">${getWeightUnit()}</span></div>
                            <div style="font-size: 12px; color: #34c759; font-weight: 600; margin-top: 4px;">-${formatWeight(totalWeightLoss)}${getWeightUnit()}</div>
                        </div>
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i> Side Effects</div>
                            <div class="stat-value" style="font-size: 28px;">${todaySideEffects ? todaySideEffects.length : 0}</div>
                            <div style="font-size: 12px; color: #8e8e93; margin-top: 4px;">today</div>
                        </div>
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="syringe" style="width: 14px; height: 14px;"></i> Total Shots</div>
                            <div class="stat-value" style="font-size: 28px;">${totalShots}</div>
                            <div style="font-size: 12px; color: #8e8e93; margin-top: 4px;">all time</div>
                        </div>
                    </div>
                </div>

                ${todaySideEffects && todaySideEffects.length > 0 ? `
                <div class="ios-card" style="margin-bottom: 20px;">
                    <div class="ios-card-header"><i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i> Side effects today</div>
                    ${todaySideEffects.map(se => `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <span style="font-size: 15px;">${se.symptom}</span>
                            <span style="font-size: 13px; color: #8e8e93; text-transform: capitalize;">${se.severity}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div style="margin-bottom: 20px;">
                    <h2 class="ios-card-header" style="font-size: 22px; margin-bottom: 12px;">Progress</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="syringe" style="width: 14px; height: 14px;"></i> Shots taken</div>
                            <div class="stat-value" style="font-size: 28px;">${totalShots}</div>
                        </div>
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="pill" style="width: 14px; height: 14px;"></i> Last dose</div>
                            <div class="stat-value" style="font-size: 28px;">${lastDose ? lastDose.dose_mg : '--'}<span style="font-size: 16px; color: #8e8e93;">mg</span></div>
                        </div>
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="trending-down" style="width: 14px; height: 14px;"></i> Total Loss</div>
                            <div class="stat-value" style="font-size: 28px;">${formatWeight(totalWeightLoss)}<span style="font-size: 16px; color: #8e8e93;">${getWeightUnit()}</span></div>
                        </div>
                    </div>
                </div>

                <div class="ios-card" style="margin-top: 20px;">
                    <h3 class="ios-card-header">Weight Progress</h3>
                    <canvas id="summaryWeightChart" style="max-height: 250px;"></canvas>
                </div>

                <div class="ios-card" style="margin-top: 12px;">
                    <h3 class="ios-card-header">Dose Tracking</h3>
                    <canvas id="summaryDoseChart" style="max-height: 250px;"></canvas>
                </div>
            `;

            // Initialize Lucide icons
            lucide.createIcons();

            // Load charts
            if (weights && weights.length > 0) {
                setTimeout(() => loadSummaryWeightChart(weights), 100);
            }
            if (doses && doses.length > 0) {
                setTimeout(() => loadSummaryDoseChart(doses), 100);
            }
        }

        function loadSummaryWeightChart(weights) {
            const ctx = document.getElementById('summaryWeightChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (summaryWeightChart) {
                summaryWeightChart.destroy();
            }

            summaryWeightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weights.map(w => new Date(w.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
                    datasets: [{
                        label: 'Weight (kg)',
                        data: weights.map(w => w.weight_kg),
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function loadSummaryDoseChart(doses) {
            const ctx = document.getElementById('summaryDoseChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (summaryDoseChart) {
                summaryDoseChart.destroy();
            }

            // Reverse for chronological order
            const sortedDoses = [...doses].reverse();

            summaryDoseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDoses.map(d => new Date(d.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
                    datasets: [{
                        label: 'Dose (mg)',
                        data: sortedDoses.map(d => d.dose_mg),
                        backgroundColor: '#667eea',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Shots Page Loader
        async function loadShotsPage() {
            const container = document.getElementById('shotsContent');
            if (!container) return;

            // Get all doses
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            const totalShots = doses ? doses.length : 0;
            const lastDose = doses && doses.length > 0 ? doses[0] : null;

            // Calculate next dose
            let nextDoseHtml = '';
            if (lastDose) {
                const lastDoseDate = new Date(lastDose.date);
                const frequency = 7; // Default weekly
                const nextDoseDate = new Date(lastDoseDate);
                nextDoseDate.setDate(lastDoseDate.getDate() + frequency);

                const now = new Date();
                const daysUntil = Math.ceil((nextDoseDate - now) / (1000 * 60 * 60 * 24));

                let daysText = '';
                let statusColor = '#667eea';
                if (daysUntil < 0) {
                    daysText = `Overdue by ${Math.abs(daysUntil)} days`;
                    statusColor = '#f5576c';
                } else if (daysUntil === 0) {
                    daysText = 'Due today!';
                    statusColor = '#00f2fe';
                } else if (daysUntil === 1) {
                    daysText = 'Due tomorrow';
                    statusColor = '#00f2fe';
                } else {
                    daysText = `In ${daysUntil} days`;
                }

                nextDoseHtml = `
                    <div class="ios-card" style="background: linear-gradient(135deg, ${statusColor} 0%, #764ba2 100%); color: white; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;"><i data-lucide="syringe" style="width: 14px; height: 14px;"></i> Next Scheduled Shot</div>
                                <div style="font-size: 32px; font-weight: 700;">${lastDose.dose_mg}<span style="font-size: 20px; opacity: 0.9;">mg</span></div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 600;">${nextDoseDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">${daysText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Stats
            let statsHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="syringe" style="width: 14px; height: 14px;"></i> Total</div>
                            <div class="stat-value" style="font-size: 28px;">${totalShots}</div>
                            <div style="font-size: 12px; color: #8e8e93; margin-top: 4px;">shots</div>
                        </div>
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="pill" style="width: 14px; height: 14px;"></i> Last Dose</div>
                            <div class="stat-value" style="font-size: 28px;">${lastDose ? lastDose.dose_mg : '--'}<span style="font-size: 16px; color: #8e8e93;">mg</span></div>
                            <div style="font-size: 12px; color: #8e8e93; margin-top: 4px;">${lastDose ? new Date(lastDose.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : 'N/A'}</div>
                        </div>
                        <div class="ios-card">
                            <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;"><i data-lucide="calendar-days" style="width: 14px; height: 14px;"></i> Frequency</div>
                            <div class="stat-value" style="font-size: 28px;">7</div>
                            <div style="font-size: 12px; color: #8e8e93; margin-top: 4px;">days</div>
                        </div>
                    </div>
                </div>
            `;

            // Dose progression chart
            let chartHtml = '';
            if (doses && doses.length > 0) {
                chartHtml = `
                    <div class="ios-card" style="margin-bottom: 20px;">
                        <h3 class="ios-card-header"><i data-lucide="trending-up" style="width: 16px; height: 16px;"></i> Dose Progression</h3>
                        <canvas id="shotsProgressChart" style="max-height: 200px;"></canvas>
                    </div>
                `;
            }

            // Titration Schedule
            // Use first dose date or current date for calculations
            const startDate = doses && doses.length > 0 ? new Date(doses[doses.length - 1].date) : new Date();
            let titrationHtml = `
                <div class="ios-card" style="margin-bottom: 20px;">
                    <h3 class="ios-card-header"><i data-lucide="calendar-range" style="width: 16px; height: 16px;"></i> Typical Titration Schedule</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                        ${generateTitrationSchedule(startDate)}
                    </div>
                </div>
            `;

            // History
            let historyHtml = '<div style="margin-bottom: 20px;"><h2 class="ios-card-header" style="font-size: 22px; margin-bottom: 12px;"><i data-lucide="history" style="width: 22px; height: 22px;"></i> History</h2></div>';

            if (doses && doses.length > 0) {
                // Group by month
                const groupedByMonth = {};
                doses.forEach(dose => {
                    const monthKey = new Date(dose.date).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    if (!groupedByMonth[monthKey]) groupedByMonth[monthKey] = [];
                    groupedByMonth[monthKey].push(dose);
                });

                Object.keys(groupedByMonth).forEach(month => {
                    historyHtml += `<div style="color: #8e8e93; font-size: 13px; font-weight: 600; margin: 20px 0 10px 0; text-transform: uppercase;">${month}</div>`;
                    groupedByMonth[month].forEach((dose, idx) => {
                        historyHtml += `
                            <div class="ios-card" style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-size: 13px; color: #8e8e93; margin-bottom: 4px;">${new Date(dose.date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' })}</div>
                                        <div class="stat-value" style="font-size: 24px;">${dose.dose_mg}<span style="font-size: 16px; color: #8e8e93;">mg</span></div>
                                    </div>
                                    <div style="background: var(--bg-primary); padding: 4px 12px; border-radius: 12px; font-size: 13px; color: #8e8e93;">
                                        Shot #${totalShots - doses.indexOf(dose)}
                                    </div>
                                </div>
                                ${dose.injection_site ? `<div style="font-size: 13px; color: #8e8e93; margin-top: 8px;"><i data-lucide="map-pin" style="width: 12px; height: 12px;"></i> ${dose.injection_site}</div>` : ''}
                                ${dose.notes ? `<div style="font-size: 13px; color: #8e8e93; margin-top: 4px; padding-top: 8px; border-top: 1px solid var(--border-light);">${dose.notes}</div>` : ''}
                            </div>
                        `;
                    });
                });
            } else {
                historyHtml += `
                    <div class="ios-card" style="text-align: center; padding: 40px 20px; color: #8e8e93;">
                        <i data-lucide="syringe" style="width: 48px; height: 48px; margin: 0 auto 12px; opacity: 0.5;"></i>
                        <div>No shots logged yet</div>
                        <button onclick="quickLogDose()" style="margin-top: 16px; background: #007AFF; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">Log Your First Shot</button>
                    </div>
                `;
            }

            container.innerHTML = statsHtml + nextDoseHtml + chartHtml + titrationHtml + historyHtml;
            lucide.createIcons();

            // Load chart if data exists
            if (doses && doses.length > 0) {
                loadShotsChart(doses);
            }
        }

        function generateTitrationSchedule(startDate) {
            const schedule = [
                { weekStart: 1, weekEnd: 4, dose: '2.5mg', color: '#667eea' },
                { weekStart: 5, weekEnd: 8, dose: '5mg', color: '#764ba2' },
                { weekStart: 9, weekEnd: 12, dose: '7.5mg', color: '#f093fb' },
                { weekStart: 13, weekEnd: 16, dose: '10mg', color: '#f5576c' },
                { weekStart: 17, weekEnd: 20, dose: '12.5mg', color: '#4facfe' },
                { weekStart: 21, weekEnd: null, dose: '15mg', color: '#00f2fe' }
            ];

            // Calculate current week number from start date
            const now = new Date();
            const start = new Date(startDate);
            const daysDiff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
            const currentWeek = Math.floor(daysDiff / 7) + 1;

            return schedule.map(item => {
                // Calculate date range
                const weekStartDate = new Date(startDate);
                weekStartDate.setDate(startDate.getDate() + ((item.weekStart - 1) * 7));

                let dateRange = '';
                if (item.weekEnd) {
                    const weekEndDate = new Date(startDate);
                    weekEndDate.setDate(startDate.getDate() + (item.weekEnd * 7) - 1);
                    dateRange = `${weekStartDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${weekEndDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
                } else {
                    dateRange = `${weekStartDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} onwards`;
                }

                // Check if this is the current week
                const isCurrent = currentWeek >= item.weekStart && (item.weekEnd === null || currentWeek <= item.weekEnd);

                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 4px; height: 40px; background: ${item.color}; border-radius: 2px;"></div>
                            <div>
                                <div style="font-size: 13px; color: #8e8e93;">Week ${item.weekEnd ? item.weekStart + '-' + item.weekEnd : item.weekStart + '+'}</div>
                                <div class="ios-card-header" style="font-size: 17px; margin-bottom: 0;">${item.dose}</div>
                                <div style="font-size: 12px; color: #8e8e93; margin-top: 2px;">${dateRange}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            ${isCurrent ? '<span style="font-size: 13px; color: #007AFF; font-weight: 600; display: flex; align-items: center; gap: 4px;"><span style="font-size: 16px;">‚≠ê</span> Current</span>' : '<div style="font-size: 13px; color: #8e8e93;">Weekly</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadShotsChart(doses) {
            const ctx = document.getElementById('shotsProgressChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (shotsProgressChart) {
                shotsProgressChart.destroy();
            }

            // Prepare data (reverse for chronological order)
            const reversedDoses = [...doses].reverse();
            const labels = reversedDoses.map((d, idx) => `Shot ${idx + 1}`);
            const data = reversedDoses.map(d => d.dose_mg);

            shotsProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dose (mg)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    const idx = context[0].dataIndex;
                                    const dose = reversedDoses[idx];
                                    return new Date(dose.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                                },
                                label: function(context) {
                                    return 'Dose: ' + context.parsed.y + 'mg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'mg';
                                }
                            }
                        },
                        x: {
                            display: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Results Page Loader
        async function loadResultsPage() {
            console.log('üìä Loading Results Page...');
            const container = document.getElementById('resultsContent');
            if (!container) {
                console.error('‚ùå Results container not found');
                return;
            }

            try {
                console.log('üîç Fetching weight data for user:', currentUser?.id);
                const { data: weights, error: weightsError } = await supabase
                    .from('weight_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: true });

                console.log('üì¶ Weights data:', weights, 'Error:', weightsError);

                if (weightsError) {
                    console.error('‚ùå Error loading weights:', weightsError);
                    throw weightsError;
                }

                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('height_cm, goal_weight_kg')
                    .eq('id', currentUser.id)
                    .single();

                console.log('üë§ Profile data:', profile, 'Error:', profileError);

                if (profileError && profileError.code !== 'PGRST116') {
                    console.error('‚ùå Error loading profile:', profileError);
                }

                // If no weight data exists, show empty state
                if (!weights || weights.length === 0) {
                    console.log('‚ö†Ô∏è No weight data found, showing empty state');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i data-lucide="scale" style="width: 64px; height: 64px; color: #8e8e93; margin: 0 auto 20px; opacity: 0.5;"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 20px;">No Weight Data Yet</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 24px;">Start tracking your weight to see progress and insights here.</p>
                            <button onclick="quickLogWeight()" class="btn-primary">Log Weight</button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                console.log('‚úÖ Found', weights.length, 'weight entries, rendering page...');

                const currentWeight = weights[weights.length - 1].weight_kg;
                const startWeight = weights[0].weight_kg;
                const totalChange = currentWeight - startWeight;

                // Calculate BMI
                const heightM = profile?.height_cm ? profile.height_cm / 100 : 0;
                const bmi = heightM > 0 && currentWeight > 0 ? (currentWeight / (heightM * heightM)).toFixed(1) : '--';

                // Calculate weight loss rate and predictions
                let weightLossRate = 0;
                let daysToGoal = '--';
                let estimatedDate = '';

                if (weights.length >= 2) {
                    const firstDate = new Date(weights[0].date);
                    const lastDate = new Date(weights[weights.length - 1].date);
                    const daysDiff = Math.max(1, (lastDate - firstDate) / (1000 * 60 * 60 * 24));
                    weightLossRate = Math.abs(totalChange / daysDiff); // kg per day

                    if (profile?.goal_weight_kg && currentWeight > profile.goal_weight_kg && weightLossRate > 0) {
                        const weightToLose = currentWeight - profile.goal_weight_kg;
                        daysToGoal = Math.ceil(weightToLose / weightLossRate);
                        const goalDate = new Date();
                        goalDate.setDate(goalDate.getDate() + daysToGoal);
                        estimatedDate = goalDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                    }
                }

                const weeklyRate = (weightLossRate * 7).toFixed(2);
                const monthlyRate = (weightLossRate * 30).toFixed(2);

            container.innerHTML = `
                <!-- Motivation Banner -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 24px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 18px; font-weight: 600; line-height: 1.6; margin-bottom: 8px;">I believe in you, my sweet Bunny.</div>
                    <div style="font-size: 16px; line-height: 1.6; opacity: 0.95;">You are so strong, I'm so proud of you.</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 12px; font-style: italic;">- Kitty üê±üíú</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h2 class="ios-card-header" style="font-size: 22px; margin-bottom: 12px;"><i data-lucide="scale" style="width: 22px; height: 22px;"></i> Weight Stats</h2>
                    <div class="stats-grid">
                        <div class="ios-card">
                            <div class="stat-label"><i data-lucide="trending-down" style="width: 14px; height: 14px;"></i> Total change</div>
                            <div class="stat-value">${formatWeight(Math.abs(totalChange))}<span class="stat-unit">${getWeightUnit()}</span></div>
                        </div>
                        <div class="ios-card">
                            <div class="stat-label"><i data-lucide="user" style="width: 14px; height: 14px;"></i> Current BMI</div>
                            <div class="stat-value">${bmi}</div>
                        </div>
                        <div class="ios-card">
                            <div class="stat-label"><i data-lucide="scale" style="width: 14px; height: 14px;"></i> Weight</div>
                            <div class="stat-value">${formatWeight(currentWeight)}<span class="stat-unit">${getWeightUnit()}</span></div>
                        </div>
                    </div>
                </div>

                ${weights && weights.length >= 2 ? `
                <div style="margin-bottom: 20px;">
                    <h2 class="ios-card-header" style="font-size: 22px; margin-bottom: 12px;"><i data-lucide="trending-up" style="width: 22px; height: 22px;"></i> Predictions & Insights</h2>

                    <div class="ios-card" style="margin-bottom: 12px;">
                        <h3 class="ios-card-header">Weight Loss Rate</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                            <div>
                                <div style="font-size: 13px; color: #8e8e93; margin-bottom: 4px;">Weekly</div>
                                <div class="stat-value" style="font-size: 24px;">${formatWeight(weeklyRate)}<span style="font-size: 14px; color: #8e8e93;">${getWeightUnit()}</span></div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #8e8e93; margin-bottom: 4px;">Monthly</div>
                                <div class="stat-value" style="font-size: 24px;">${formatWeight(monthlyRate)}<span style="font-size: 14px; color: #8e8e93;">${getWeightUnit()}</span></div>
                            </div>
                        </div>
                    </div>

                    ${estimatedDate ? `
                    <div class="ios-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;"><i data-lucide="calendar-check" style="width: 14px; height: 14px;"></i> Estimated Goal Date</div>
                                <div style="font-size: 20px; font-weight: 700;">${estimatedDate}</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">~${daysToGoal} days to go</div>
                            </div>
                            <i data-lucide="target" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <div class="ios-card">
                    <h3 class="ios-card-header">Weight Progress</h3>
                    <canvas id="resultsWeightChart" style="max-height: 300px;"></canvas>
                </div>
            `;

                lucide.createIcons();

                // Load weight chart if weights exist
                if (weights && weights.length > 0) {
                    loadResultsChart(weights);
                }
            } catch (error) {
                console.error('Error loading results page:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i data-lucide="alert-circle" style="width: 64px; height: 64px; color: #ef4444; margin: 0 auto 20px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 20px;">Error Loading Results</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">There was an error loading your results. Please try again.</p>
                        <button onclick="loadResultsPage()" class="btn-primary">Retry</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function loadResultsChart(weights) {
            const ctx = document.getElementById('resultsWeightChart');
            if (!ctx) {
                console.error('Chart canvas not found');
                return;
            }

            // Destroy existing chart if it exists
            if (resultsWeightChart) {
                resultsWeightChart.destroy();
            }

            try {
                resultsWeightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weights.map(w => new Date(w.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
                        datasets: [{
                            label: 'Weight (kg)',
                            data: weights.map(w => w.weight_kg),
                            borderColor: '#007AFF',
                            backgroundColor: 'rgba(0, 122, 255, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (error) {
                console.error('Error creating chart:', error);
                // Chart failed but page content is still visible
            }
        }

        // Calendar Page Loader
        let currentCalendarYear, currentCalendarMonth;

        async function loadCalendarPage() {
            const container = document.getElementById('calendarContent');
            if (!container) return;

            const now = new Date();
            currentCalendarYear = now.getFullYear();
            currentCalendarMonth = now.getMonth();

            await renderCalendar();
            await selectCalendarDate(now.getDate());
        }

        async function renderCalendar() {
            const container = document.getElementById('calendarContent');
            if (!container) return;

            const now = new Date();
            const currentMonth = new Date(currentCalendarYear, currentCalendarMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const currentDay = now.getDate();
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Adjust so Monday is 0

            // Fetch all data for the month
            const firstDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth, 1).toISOString().split('T')[0];
            const lastDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).toISOString().split('T')[0];

            const { data: doses } = await supabase
                .from('dose_entries')
                .select('date, dose_mg')
                .eq('user_id', currentUser.id)
                .gte('date', firstDayOfMonth)
                .lte('date', lastDayOfMonth);

            const { data: weights } = await supabase
                .from('weight_entries')
                .select('date, weight_kg')
                .eq('user_id', currentUser.id)
                .gte('date', firstDayOfMonth)
                .lte('date', lastDayOfMonth);

            const { data: sideEffects } = await supabase
                .from('side_effects')
                .select('date')
                .eq('user_id', currentUser.id)
                .gte('date', firstDayOfMonth)
                .lte('date', lastDayOfMonth);

            // Create lookup maps
            const doseMap = {};
            const weightMap = {};
            const sideEffectMap = {};

            doses?.forEach(d => {
                const day = new Date(d.date).getDate();
                if (!doseMap[day]) doseMap[day] = [];
                doseMap[day].push(d.dose_mg);
            });

            weights?.forEach(w => {
                const day = new Date(w.date).getDate();
                weightMap[day] = w.weight_kg;
            });

            sideEffects?.forEach(s => {
                const day = new Date(s.date).getDate();
                sideEffectMap[day] = (sideEffectMap[day] || 0) + 1;
            });

            let calendarHTML = `
                <div class="calendar-header">${currentMonth}</div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">MON</div>
                    <div class="calendar-day-header">TUE</div>
                    <div class="calendar-day-header">WED</div>
                    <div class="calendar-day-header">THU</div>
                    <div class="calendar-day-header">FRI</div>
                    <div class="calendar-day-header">SAT</div>
                    <div class="calendar-day-header">SUN</div>
            `;

            // Add empty cells for days before the first of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === currentDay && currentCalendarMonth === now.getMonth() && currentCalendarYear === now.getFullYear();
                const hasData = doseMap[day] || weightMap[day] || sideEffectMap[day];

                let indicators = '';
                if (doseMap[day]) indicators += '<div style="width: 4px; height: 4px; background: #f5576c; border-radius: 50%; display: inline-block; margin: 0 1px;"></div>';
                if (weightMap[day]) indicators += '<div style="width: 4px; height: 4px; background: #667eea; border-radius: 50%; display: inline-block; margin: 0 1px;"></div>';
                if (sideEffectMap[day]) indicators += '<div style="width: 4px; height: 4px; background: #00f2fe; border-radius: 50%; display: inline-block; margin: 0 1px;"></div>';

                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${hasData ? 'has-data' : ''}" onclick="selectCalendarDate(${day})" style="cursor: pointer;">
                        <div>${day}</div>
                        ${indicators ? `<div style="margin-top: 4px; display: flex; justify-content: center; gap: 2px;">${indicators}</div>` : ''}
                    </div>
                `;
            }

            calendarHTML += '</div>';
            calendarHTML += '<div id="selectedDateDetails" style="margin-top: 20px;"></div>';

            container.innerHTML = calendarHTML;
            lucide.createIcons();
        }

        async function selectCalendarDate(day) {
            const detailsContainer = document.getElementById('selectedDateDetails');
            if (!detailsContainer) return;

            // Remove active class from all days
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));

            // Add active class to clicked day
            const dayElements = document.querySelectorAll('.calendar-day');
            dayElements.forEach(el => {
                if (el.textContent.trim() === day.toString() && el.onclick) {
                    el.classList.add('selected');
                }
            });

            // Fix: Construct date string directly to avoid timezone issues
            const selectedDate = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Fetch data for selected date
            const { data: weight } = await supabase
                .from('weight_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', selectedDate)
                .single();

            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', selectedDate);

            const { data: sideEffects } = await supabase
                .from('side_effects')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', selectedDate);

            // Fix: Parse date correctly to avoid timezone issues
            const [year, month, dayNum] = selectedDate.split('-');
            const dateObj = new Date(year, month - 1, dayNum);

            // Check if selected date is today (avoid timezone issues)
            const now = new Date();
            const todayDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const isToday = selectedDate === todayDate;

            const dateDisplay = isToday ? `Today, ${dayNum} ${dateObj.toLocaleDateString('en-GB', { month: 'long' })}` : dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

            // Prepare data for display
            const shotData = doses && doses.length > 0 ? doses[0] : null;
            const weightData = weight;
            const sideEffectsData = sideEffects && sideEffects.length > 0 ? sideEffects : null;

            const detailsHTML = `
                <h2 class="ios-card-header" style="font-size: 22px; margin-bottom: 16px;">${dateDisplay}</h2>

                <!-- Shot and Est. Level Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <!-- Shot Card -->
                    <div class="ios-card" onclick="showAddShotModal('${selectedDate}')" style="cursor: pointer;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <i data-lucide="syringe" style="width: 16px; height: 16px; color: #007AFF; margin-right: 6px;"></i>
                            <span class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Shot</span>
                        </div>
                        <div class="stat-value" style="font-size: 28px; margin-bottom: 4px;">
                            ${shotData ? shotData.dose_mg + 'mg' : '‚Äî'}
                        </div>
                        <div style="font-size: 13px; color: #8e8e93;">
                            ${shotData ? (shotData.injection_site || '') : 'Tap to add shot'}
                        </div>
                    </div>

                    <!-- Est. Level Card -->
                    <div class="ios-card">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <i data-lucide="trending-up" style="width: 16px; height: 16px; color: #007AFF; margin-right: 6px;"></i>
                            <span class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Est. level</span>
                        </div>
                        <div class="stat-value" style="font-size: 28px; margin-bottom: 4px;">‚Äî</div>
                        <div style="font-size: 13px; color: #8e8e93;">No data</div>
                    </div>
                </div>

                <!-- Weight Card -->
                <div class="ios-card" onclick="showAddWeightModal('${selectedDate}')" style="cursor: pointer; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <i data-lucide="activity" style="width: 16px; height: 16px; color: #007AFF; margin-right: 6px;"></i>
                        <span class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Weight</span>
                    </div>
                    <div class="stat-value" style="font-size: 28px; margin-bottom: 4px;">
                        ${weightData ? formatWeight(weightData.weight_kg) + getWeightUnit() : '‚Äî'}
                    </div>
                    <div style="font-size: 13px; color: #8e8e93;">
                        ${weightData ? (weightData.notes || 'Weight logged') : 'Tap to add weight'}
                    </div>
                </div>

                <!-- Side Effects Card -->
                <div class="ios-card" onclick="showAddSideEffectModal('${selectedDate}')" style="cursor: pointer; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <i data-lucide="waves" style="width: 16px; height: 16px; color: #007AFF; margin-right: 6px;"></i>
                        <span class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Side effects</span>
                    </div>
                    ${sideEffectsData ? `
                        <div class="ios-card-header" style="font-size: 15px; margin-top: 8px; margin-bottom: 0;">
                            ${sideEffectsData.map(se => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                                    <span style="font-weight: 500;">${se.symptom}</span>
                                    <span style="font-size: 13px; color: #8e8e93; text-transform: capitalize;">${se.severity}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="font-size: 13px; color: #8e8e93;">Tap to add side effects</div>
                    `}
                </div>

                <!-- Notes Card -->
                <div class="ios-card" style="cursor: pointer;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <i data-lucide="file-text" style="width: 16px; height: 16px; color: #007AFF; margin-right: 6px;"></i>
                        <span class="ios-card-header" style="font-size: 13px; margin-bottom: 0;">Notes for day</span>
                    </div>
                    <div style="font-size: 13px; color: #8e8e93;">Tap to add notes</div>
                </div>
            `;

            detailsContainer.innerHTML = detailsHTML;
            lucide.createIcons();
        }

        function showAddShotModal(date) {
            openBottomsheet('doseBottomsheet');
            const dateInput = document.getElementById('quickDoseDate');
            if (dateInput) {
                dateInput.value = date;
            }
            loadQuickMedications();
        }

        function showAddWeightModal(date) {
            openBottomsheet('weightBottomsheet');
            const dateInput = document.getElementById('quickWeightDate');
            if (dateInput) {
                dateInput.value = date;
            }
        }

        function showAddSideEffectModal(date) {
            openBottomsheet('sideEffectBottomsheet');
            const dateInput = document.getElementById('quickSideEffectDate');
            if (dateInput) {
                dateInput.value = date;
            }
        }

        function goToToday() {
            loadCalendarPage();
        }

        // Settings Page Loader
        function loadSettingsPage() {
            const container = document.getElementById('settingsContent');
            if (!container) return;

            container.innerHTML = `
                <div class="settings-list">
                    <div class="setting-item" onclick="showMeasurementUnits()">
                        <div class="setting-left">
                            <i data-lucide="ruler" class="setting-icon"></i>
                            <span class="setting-label">Measurement Units</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showHeightGoalWeight()">
                        <div class="setting-left">
                            <i data-lucide="target" class="setting-icon"></i>
                            <span class="setting-label">Height & Goal Weight</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showDaysBetweenShots()">
                        <div class="setting-left">
                            <i data-lucide="calendar-days" class="setting-icon"></i>
                            <span class="setting-label">Days Between Shots</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showStartDate()">
                        <div class="setting-left">
                            <i data-lucide="calendar-check" class="setting-icon"></i>
                            <span class="setting-label">Start Date</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showMedications()">
                        <div class="setting-left">
                            <i data-lucide="pill" class="setting-icon"></i>
                            <span class="setting-label">Medications</span>
                        </div>
                    </div>
                </div>

                <div class="settings-list">
                    <div class="setting-item" onclick="exportToExcel()">
                        <div class="setting-left">
                            <i data-lucide="download" class="setting-icon"></i>
                            <span class="setting-label">Export Data</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="handleLogout()">
                        <div class="setting-left">
                            <i data-lucide="log-out" class="setting-icon"></i>
                            <span class="setting-label">Logout</span>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function closeModal() {
            const modal = document.getElementById('modalContainer');
            modal.classList.add('hidden');
            modal.innerHTML = '';
        }

        async function showMeasurementUnits() {
            const modal = document.getElementById('modalContainer');
            const { data: profile } = await supabase
                .from('profiles')
                .select('measurement_unit')
                .eq('id', currentUser.id)
                .single();

            const currentUnit = profile?.measurement_unit || 'metric';

            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="settings-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Measurement Units</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="unit" value="metric" ${currentUnit === 'metric' ? 'checked' : ''}>
                                    <div>
                                        <div class="radio-label">Metric</div>
                                        <div class="radio-description">Kilograms (kg)</div>
                                    </div>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="unit" value="imperial" ${currentUnit === 'imperial' ? 'checked' : ''}>
                                    <div>
                                        <div class="radio-label">Imperial</div>
                                        <div class="radio-description">Pounds (lbs)</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveMeasurementUnit()">Save</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function saveMeasurementUnit() {
            const selectedUnit = document.querySelector('input[name="unit"]:checked').value;
            await supabase
                .from('profiles')
                .update({ measurement_unit: selectedUnit })
                .eq('id', currentUser.id);

            // Update current user profile in memory
            if (currentUser.profile) {
                currentUser.profile.measurement_unit = selectedUnit;
            }

            closeModal();

            // Reload the current page to reflect changes
            const currentTab = document.querySelector('.nav-item.active');
            if (currentTab) {
                const tabId = currentTab.getAttribute('data-tab');
                if (tabId === 'summary') loadSummaryPage();
                else if (tabId === 'shots') loadShotsPage();
                else if (tabId === 'results') loadResultsPage();
                else if (tabId === 'calendar') loadCalendarPage();
            }
        }

        async function showHeightGoalWeight() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('height_cm, goal_weight_kg')
                .eq('id', currentUser.id)
                .single();

            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="settings-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Height & Goal Weight</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Height (cm)</label>
                                <input type="number" id="heightInput" placeholder="170" value="${profile?.height_cm || ''}" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Goal Weight (kg)</label>
                                <input type="number" id="goalWeightInput" placeholder="70" value="${profile?.goal_weight_kg || ''}" step="0.1">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveHeightGoalWeight()">Save</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function saveHeightGoalWeight() {
            const height = parseFloat(document.getElementById('heightInput').value);
            const goalWeight = parseFloat(document.getElementById('goalWeightInput').value);

            await supabase
                .from('profiles')
                .update({
                    height_cm: height || null,
                    goal_weight_kg: goalWeight || null
                })
                .eq('id', currentUser.id);

            // Update current user profile in memory
            if (currentUser.profile) {
                currentUser.profile.height_cm = height || null;
                currentUser.profile.goal_weight_kg = goalWeight || null;
            }

            closeModal();

            // Reload the current page to reflect changes
            const currentTab = document.querySelector('.nav-item.active');
            if (currentTab) {
                const tabId = currentTab.getAttribute('data-tab');
                if (tabId === 'summary') loadSummaryPage();
                else if (tabId === 'shots') loadShotsPage();
                else if (tabId === 'results') loadResultsPage();
                else if (tabId === 'calendar') loadCalendarPage();
            }
        }

        async function showDaysBetweenShots() {
            const { data: medication } = await supabase
                .from('medications')
                .select('frequency_days')
                .eq('user_id', currentUser.id)
                .single();

            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="settings-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Days Between Shots</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Frequency (days)</label>
                                <input type="number" id="frequencyInput" placeholder="7" value="${medication?.frequency_days || 7}" min="1" max="365">
                                <small>How many days between each dose</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveFrequency()">Save</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function saveFrequency() {
            const frequency = parseInt(document.getElementById('frequencyInput').value);

            const { data: existing } = await supabase
                .from('medications')
                .select('id')
                .eq('user_id', currentUser.id)
                .single();

            if (existing) {
                await supabase
                    .from('medications')
                    .update({ frequency_days: frequency })
                    .eq('user_id', currentUser.id);
            } else {
                await supabase
                    .from('medications')
                    .insert({
                        user_id: currentUser.id,
                        name: 'Zepbound',
                        frequency_days: frequency,
                        is_active: true
                    });
            }

            closeModal();

            // Reload the current page to reflect changes
            const currentTab = document.querySelector('.nav-item.active');
            if (currentTab) {
                const tabId = currentTab.getAttribute('data-tab');
                if (tabId === 'summary') loadSummaryPage();
                else if (tabId === 'shots') loadShotsPage();
                else if (tabId === 'results') loadResultsPage();
                else if (tabId === 'calendar') loadCalendarPage();
            }
        }

        async function showStartDate() {
            // Get current medication with start date
            const { data: medication } = await supabase
                .from('medications')
                .select('start_date')
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .single();

            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="settings-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Start Date</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px 16px;">
                            <div class="form-group">
                                <label>When did you start your medication?</label>
                                <input type="date" id="startDateInput" value="${medication?.start_date || new Date().toISOString().split('T')[0]}">
                                <small>This date is used to calculate your progress and schedule</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="updateStartDate()">Save</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function updateStartDate() {
            const startDate = document.getElementById('startDateInput').value;

            if (!startDate) {
                alert('Please select a start date');
                return;
            }

            const { data: existing } = await supabase
                .from('medications')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .single();

            if (existing) {
                await supabase
                    .from('medications')
                    .update({ start_date: startDate })
                    .eq('user_id', currentUser.id)
                    .eq('is_active', true);
            }

            closeModal();

            // Reload the current page to reflect changes
            const currentTab = document.querySelector('.nav-item.active');
            if (currentTab) {
                const tabId = currentTab.getAttribute('data-tab');
                if (tabId === 'summary') loadSummaryPage();
                else if (tabId === 'shots') loadShotsPage();
                else if (tabId === 'results') loadResultsPage();
                else if (tabId === 'calendar') loadCalendarPage();
            }
        }

        async function showMedications() {
            const { data: medications } = await supabase
                .from('medications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="settings-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Medications</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${medications && medications.length > 0 ? `
                                <div class="medication-list">
                                    ${medications.map(med => `
                                        <div class="medication-item">
                                            <div>
                                                <div style="font-weight: 600; color: var(--text-primary);">${med.name}</div>
                                                <div style="font-size: 13px; color: var(--text-secondary);">Every ${med.frequency_days} days</div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span class="badge ${med.is_active ? 'badge-success' : 'badge-secondary'}">${med.is_active ? 'Active' : 'Inactive'}</span>
                                                <button onclick="deleteMedication('${med.id}')" style="background: #ff3b30; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">Delete</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="text-align: center; color: var(--text-secondary);">No medications added yet</p>'}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn btn-primary" onclick="showAddMedication()">Add Medication</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function showAddMedication() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="settings-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Add Medication</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Medication Name</label>
                                <input type="text" id="medicationName" placeholder="e.g., Zepbound, Mounjaro">
                            </div>
                            <div class="form-group">
                                <label>Frequency (days)</label>
                                <input type="number" id="medicationFrequency" placeholder="7" value="7" min="1" max="365">
                            </div>
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="medicationStartDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="showMedications()">Back</button>
                            <button class="btn btn-primary" onclick="saveMedication()">Save</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveMedication() {
            const name = document.getElementById('medicationName').value.trim();
            const frequency = parseInt(document.getElementById('medicationFrequency').value);
            const startDate = document.getElementById('medicationStartDate').value;

            if (!name) {
                alert('Please enter a medication name');
                return;
            }

            await supabase
                .from('medications')
                .insert({
                    user_id: currentUser.id,
                    name: name,
                    frequency_days: frequency,
                    start_date: startDate,
                    is_active: true
                });

            showMedications();
        }

        async function deleteMedication(medId) {
            if (!confirm('Are you sure you want to delete this medication?')) {
                return;
            }

            await supabase
                .from('medications')
                .delete()
                .eq('id', medId)
                .eq('user_id', currentUser.id);

            // Refresh the medications list
            showMedications();
        }

        function toggleMenu() {
            console.log('Menu toggled');
            // TODO: Implement menu
        }

        let retaDoseChart = null;

        async function loadRetaData() {
            await loadRetaDoseSchedule();
            await loadRetaRecentDoses();
            await loadRetaDoseChart();
        }

        async function loadRetaDoseSchedule() {
            const container = document.getElementById('retaDoseSchedule');

            // Get medication with start date
            const { data: meds } = await supabase
                .from('medications')
                .select('id, start_date')
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .limit(1);

            if (!meds || meds.length === 0) {
                container.innerHTML = '<div class="empty-state">No medication found</div>';
                return;
            }

            const med = meds[0];
            const startDate = new Date(med.start_date);

            const { data: schedule } = await supabase
                .from('titration_schedules')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('medication_id', med.id)
                .order('week_number', { ascending: true });

            if (!schedule || schedule.length === 0) {
                container.innerHTML = '<div class="empty-state">No schedule set</div>';
                return;
            }

            // Calculate date ranges for each week
            const now = new Date();
            const daysSinceStart = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
            const currentWeek = Math.floor(daysSinceStart / 7) + 1;

            container.innerHTML = schedule.map(s => {
                const weekStartDate = new Date(startDate);
                weekStartDate.setDate(startDate.getDate() + ((s.week_number - 1) * 7));
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekStartDate.getDate() + 6);

                const isCurrentWeek = s.week_number === currentWeek;
                const dateRange = `${weekStartDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${weekEndDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;

                return `
                    <div style="padding: 12px; background: ${isCurrentWeek ? '#f0f4ff' : '#f7fafc'}; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid ${isCurrentWeek ? '#667eea' : 'transparent'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 700; color: #2d3748; font-size: 15px;">Week ${s.week_number}</span>
                                    ${isCurrentWeek ? '<span style="background: #667eea; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">CURRENT</span>' : ''}
                                </div>
                                <div style="color: #718096; font-size: 12px; margin-top: 2px;">${dateRange}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: #667eea;">${s.dose_mg}mg</div>
                                <div style="font-size: 11px; color: #718096;">Every ${s.frequency_days}d</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadRetaRecentDoses() {
            const container = document.getElementById('retaRecentDoses');

            const { data: doses } = await supabase
                .from('dose_entries')
                .select('*, medications(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(10);

            if (!doses || doses.length === 0) {
                container.innerHTML = '<div class="empty-state">No doses logged yet</div>';
                return;
            }

            container.innerHTML = doses.map(d => `
                <div class="entry">
                    <div class="entry-header">
                        <span class="entry-date">${new Date(d.date).toLocaleDateString('en-GB')}</span>
                        <span style="font-weight: 700; color: #667eea;">${d.dose_mg}mg</span>
                    </div>
                    <div class="entry-details">
                        ${d.injection_units ? `${d.injection_units} units` : ''}
                        ${d.injection_site ? ` ‚Ä¢ Site: ${d.injection_site}` : ''}
                        ${d.notes ? `<br>${d.notes}` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadRetaDoseChart() {
            const { data: doses } = await supabase
                .from('dose_entries')
                .select('date, dose_mg')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: true })
                .limit(30);

            if (!doses || doses.length === 0) return;

            const ctx = document.getElementById('retaDoseChart');

            if (retaDoseChart) {
                retaDoseChart.destroy();
            }

            retaDoseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: doses.map(d => new Date(d.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
                    datasets: [{
                        label: 'Dose (mg)',
                        data: doses.map(d => d.dose_mg),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'white',
                            titleColor: '#2d3748',
                            bodyColor: '#2d3748',
                            borderColor: '#e2e8f0',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f7fafc' },
                            ticks: {
                                callback: value => value + 'mg'
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            document.getElementById('newMedStartDate').value = today;
        }

        // Session keepalive - refresh token every 30 minutes to prevent unexpected logouts
        setInterval(async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                console.log('üîÑ Refreshing session token...');
                await supabase.auth.refreshSession();
                console.log('‚úÖ Session refreshed');
            }
        }, 30 * 60 * 1000); // 30 minutes

        // Refresh session when tab becomes visible again (fixes "leave tab and come back" issue)
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden && currentUser) {
                console.log('üëÅÔ∏è Tab became visible, refreshing session...');
                try {
                    const { data: { session }, error } = await supabase.auth.refreshSession();
                    if (error) {
                        console.error('‚ùå Error refreshing session:', error);
                        // If refresh fails, try to get existing session
                        const { data: { session: existingSession } } = await supabase.auth.getSession();
                        if (!existingSession) {
                            console.log('‚ö†Ô∏è No valid session, showing auth...');
                            showAuth();
                        }
                    } else {
                        console.log('‚úÖ Session refreshed successfully');
                    }
                } catch (error) {
                    console.error('‚ùå Error in visibility change handler:', error);
                }
            }
        });

        // Initialize app
        init();

        // Initialize Lucide icons on page load
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>